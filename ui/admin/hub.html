<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>US Signal | Partner Admin Hub</title>

<style>
  :root{
    --bg:#f6f8fb;
    --card:#ffffff;
    --text:#0f172a;
    --muted:#64748b;
    --line:rgba(15,23,42,.10);
    --shadow:0 8px 24px rgba(15,23,42,.08);

    --accent:#0f62fe;     /* executive blue */
    --accent2:#0b4bd4;

    --good:#16a34a;
    --warn:#f59e0b;
    --bad:#dc2626;

    --chip:#eef2ff;
  }

  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background:var(--bg);
    color:var(--text);
  }

  a{ color:inherit; text-decoration:none; }

  /* ====== App Shell ====== */
  .app{
    display:grid;
    grid-template-columns: 270px 1fr;
    min-height:100vh;
  }

  /* ====== Sidebar ====== */
  .sidebar{
    background:var(--card);
    border-right:1px solid var(--line);
    padding:18px 14px;
    position:sticky;
    top:0;
    height:100vh;
    display:flex;
    flex-direction:column;
    gap:14px;
  }

  .brand{
    display:flex;
    align-items:center;
    gap:12px;
    padding:10px 10px 14px 10px;
    border-bottom:1px solid var(--line);
  }

  .brand img{
    height:34px;
    width:auto;
    display:block;
  }

  .brand .title{
    display:flex;
    flex-direction:column;
    line-height:1.1;
  }
  .brand .title b{
    font-size:14px;
    letter-spacing:.2px;
  }
  .brand .title span{
    font-size:12px;
    color:var(--muted);
    margin-top:2px;
  }

  .nav{
    display:flex;
    flex-direction:column;
    gap:6px;
    padding:6px;
  }

  .nav a{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:10px 10px;
    border-radius:12px;
    font-weight:700;
    font-size:13px;
    color:rgba(15,23,42,.86);
  }

  .nav a:hover{
    background:rgba(15,98,254,.08);
    color:var(--accent2);
  }

  .nav a.active{
    background:rgba(15,98,254,.12);
    color:var(--accent2);
    border:1px solid rgba(15,98,254,.18);
  }

  .pill{
    font-size:11px;
    padding:3px 8px;
    border-radius:999px;
    background:var(--chip);
    color:var(--accent2);
    font-weight:800;
    border:1px solid rgba(15,98,254,.15);
  }

  .sidebar-bottom{
    margin-top:auto;
    padding:10px 10px;
    border-top:1px solid var(--line);
    display:flex;
    flex-direction:column;
    gap:10px;
  }

  .userline{
    font-size:12px;
    color:var(--muted);
    display:flex;
    flex-direction:column;
    gap:3px;
  }

  .btn{
    border:none;
    cursor:pointer;
    border-radius:12px;
    padding:10px 12px;
    font-weight:900;
    font-size:13px;
  }
  .btn-primary{
    background:var(--accent);
    color:#fff;
  }
  .btn-primary:hover{ background:var(--accent2); }
  .btn-outline{
    background:transparent;
    border:1px solid rgba(15,23,42,.18);
    color:var(--text);
  }
  .btn-outline:hover{ border-color:rgba(15,98,254,.35); }

  /* ====== Main ====== */
  .main{
    padding:18px 22px 28px 22px;
  }

  /* ====== Top Header ====== */
  .topbar{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:16px;
    box-shadow: var(--shadow);
    padding:14px 16px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }

  .topbar-left{
    display:flex;
    flex-direction:column;
    gap:4px;
  }

  .topbar-left .h{
    font-size:16px;
    font-weight:950;
    letter-spacing:.2px;
  }

  .topbar-left .sub{
    font-size:12px;
    color:var(--muted);
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }

  .dot{
    width:8px; height:8px; border-radius:50%;
    background:var(--warn);
    display:inline-block;
  }
  .dot.good{ background:var(--good); }
  .dot.bad{ background:var(--bad); }

  .topbar-right{
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }

  .select{
    appearance:none;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid rgba(15,23,42,.18);
    background:#fff;
    color:var(--text);
    font-weight:800;
    font-size:13px;
    min-width:240px;
    outline:none;
  }

  .select:focus{
    border-color:rgba(15,98,254,.50);
    box-shadow:0 0 0 4px rgba(15,98,254,.12);
  }

  /* ====== Grid ====== */
  .section{
    margin-top:18px;
  }

  .section-title{
    margin:16px 2px 10px 2px;
    font-weight:950;
    font-size:13px;
    color:rgba(15,23,42,.80);
    letter-spacing:.2px;
  }

  .kpi-grid{
    display:grid;
    grid-template-columns: repeat(5, minmax(180px, 1fr));
    gap:12px;
  }

  @media (max-width: 1300px){
    .kpi-grid{ grid-template-columns: repeat(3, minmax(180px, 1fr)); }
  }
  @media (max-width: 980px){
    .app{ grid-template-columns: 1fr; }
    .sidebar{ position:relative; height:auto; }
    .kpi-grid{ grid-template-columns: repeat(2, minmax(180px, 1fr)); }
  }

  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:16px;
    box-shadow: var(--shadow);
    padding:14px 14px;
  }

  .kpi{
    display:flex;
    flex-direction:column;
    gap:6px;
    min-height:92px;
  }
  .kpi .label{
    font-size:12px;
    color:var(--muted);
    font-weight:800;
  }
  .kpi .value{
    font-size:26px;
    font-weight:1000;
    letter-spacing:.2px;
  }
  .kpi .hint{
    font-size:12px;
    color:var(--muted);
  }

  .badge{
    display:inline-flex;
    align-items:center;
    gap:8px;
    border-radius:999px;
    padding:6px 10px;
    font-size:12px;
    font-weight:950;
    border:1px solid rgba(15,23,42,.10);
    background:rgba(15,23,42,.03);
  }
  .badge.good{ border-color:rgba(22,163,74,.25); background:rgba(22,163,74,.08); color:rgba(22,163,74,.95); }
  .badge.warn{ border-color:rgba(245,158,11,.30); background:rgba(245,158,11,.10); color:rgba(180,83,9,.98); }
  .badge.bad{ border-color:rgba(220,38,38,.25); background:rgba(220,38,38,.08); color:rgba(220,38,38,.95); }

  /* ====== Table ====== */
  .table-wrap{
    overflow:auto;
    border-radius:16px;
    border:1px solid var(--line);
    background:var(--card);
    box-shadow:var(--shadow);
  }

  table{
    width:100%;
    border-collapse:collapse;
    min-width: 820px;
  }

  thead th{
    text-align:left;
    font-size:12px;
    color:var(--muted);
    padding:12px 14px;
    background:rgba(15,23,42,.02);
    border-bottom:1px solid var(--line);
    text-transform:uppercase;
    letter-spacing:.4px;
  }

  tbody td{
    padding:12px 14px;
    border-bottom:1px solid rgba(15,23,42,.07);
    font-size:13px;
    vertical-align:middle;
  }

  tbody tr:hover{
    background:rgba(15,98,254,.04);
  }

  .mono{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-weight:800;
    font-size:12px;
    color:rgba(15,23,42,.70);
  }

  .right{ text-align:right; }

  .actions{
    display:flex;
    gap:8px;
    justify-content:flex-end;
  }

  .btn-xs{
    padding:8px 10px;
    border-radius:12px;
    font-weight:950;
    font-size:12px;
    border:1px solid rgba(15,23,42,.14);
    background:#fff;
    cursor:pointer;
  }
  .btn-xs:hover{ border-color:rgba(15,98,254,.30); color:var(--accent2); }

  .muted{ color:var(--muted); }
  .loading{
    padding:18px;
    color:var(--muted);
    font-weight:800;
  }
</style>
</head>

<body>
<div class="app">

  <!-- ===== SIDEBAR ===== -->
  <aside class="sidebar">
    <div class="brand">
      <!-- Logo on every page (we’ll fix if it’s not rendering) -->
      <img id="brandLogo" src="/assets/ussignal-logo.jpg" alt="US Signal" onerror="fallbackLogo()" />
      <div class="title">
        <b>Partner Portal</b>
        <span>Managed Services Console</span>
      </div>
    </div>

    <nav class="nav">
      <a class="active" href="/admin">Dashboard <span class="pill">Exec</span></a>
      <a href="/admin/customers">Customers</a>
      <a href="/admin/analytics">Analytics</a>
      <a href="/admin/licenses">Licenses</a>
      <a href="/admin/devices">Devices</a>
      <a href="/admin/alerts">Alerts</a>
      <a href="/admin/pins">PIN Management</a>
      <a href="/admin/support">Support</a>
      <a href="/admin/implementation">Implementation</a>
      <a href="/admin/pstn">PSTN</a>
      <a href="/admin/tenant-resolution">Resolution</a>
    </nav>

    <div class="sidebar-bottom">
      <div class="userline">
        <div><b id="whoami">—</b></div>
        <div class="muted" id="sessionLine">Session: —</div>
      </div>
      <button class="btn btn-outline" id="btnRefresh">Refresh</button>
      <button class="btn btn-primary" id="btnLogout">Logout</button>
    </div>
  </aside>

  <!-- ===== MAIN ===== -->
  <main class="main">
    <div class="topbar">
      <div class="topbar-left">
        <div class="h">Executive Dashboard</div>
        <div class="sub">
          <span class="badge" id="healthBadge"><span class="dot" id="healthDot"></span><span id="healthText">Evaluating health…</span></span>
          <span class="muted" id="lastUpdated">Last Updated: —</span>
        </div>
      </div>

      <div class="topbar-right">
        <select class="select" id="orgSelect">
          <option value="">All Tenants (Partner View)</option>
        </select>
        <button class="btn btn-outline" id="btnOpenCustomers" title="Go to Customers page">Customers</button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="section">
      <div class="section-title">Executive Summary</div>
      <div class="kpi-grid">
        <div class="card kpi">
          <div class="label">Total Partner Orgs</div>
          <div class="value" id="kpiOrgs">—</div>
          <div class="hint">Organizations accessible via partner token</div>
        </div>

        <div class="card kpi">
          <div class="label">Tenants Needing Attention</div>
          <div class="value" id="kpiAttention">—</div>
          <div class="hint">Deficits or offline devices detected</div>
        </div>

        <div class="card kpi">
          <div class="label">License Deficits</div>
          <div class="value" id="kpiDeficits">—</div>
          <div class="hint">Sum of deficits across scope</div>
        </div>

        <div class="card kpi">
          <div class="label">Offline Devices</div>
          <div class="value" id="kpiOffline">—</div>
          <div class="hint">Devices not currently connected</div>
        </div>

        <div class="card kpi">
          <div class="label">Call Volume (7d)</div>
          <div class="value" id="kpiCalls">—</div>
          <div class="hint">Placeholder until analytics rollup is wired</div>
        </div>
      </div>
    </div>

    <!-- Health Table -->
    <div class="section">
      <div class="section-title">Multi-Tenant Health</div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Organization</th>
              <th>License Deficit</th>
              <th>Offline Devices</th>
              <th>Call Volume</th>
              <th>Health</th>
              <th class="right">Actions</th>
            </tr>
          </thead>
          <tbody id="tenantRows">
            <tr><td colspan="6" class="loading">Loading tenants…</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </main>
</div>

<script>
  const $ = (id) => document.getElementById(id);

  function fallbackLogo(){
    // Try your absolute URL if relative fails
    const img = $("brandLogo");
    if (!img) return;
    if (!img.dataset.fallback) {
      img.dataset.fallback = "1";
      img.src = "https://webex.onenecklab.com/assets/ussignal-logo.jpg";
    }
  }

  async function api(path, opts){
    const res = await fetch(path, opts);
    const txt = await res.text();
    let data = null;
    try { data = txt ? JSON.parse(txt) : null; } catch { data = { raw: txt }; }

    if (!res.ok){
      if (res.status === 401){
        window.location.href = "/pin";
        return null;
      }
      const msg = (data && (data.message || data.error)) || ("API failed: " + path);
      throw new Error(msg);
    }
    return data;
  }

  function setHealthBadge(state, text){
    const badge = $("healthBadge");
    const dot = $("healthDot");
    const label = $("healthText");

    badge.classList.remove("good","warn","bad");
    dot.classList.remove("good","bad");

    if (state === "good"){
      badge.classList.add("good");
      dot.classList.add("good");
    } else if (state === "bad"){
      badge.classList.add("bad");
      dot.classList.add("bad");
    } else {
      badge.classList.add("warn");
    }
    label.textContent = text;
  }

  function healthLabel(deficit, offline){
    if ((deficit||0) > 0 || (offline||0) > 0) return { state:"warn", text:"Attention" };
    return { state:"good", text:"Healthy" };
  }

  function renderRow(o){
    const deficit = Number(o.deficit || 0);
    const offline = Number(o.offline || 0);
    const callVol = o.callVolume ?? "—";

    const h = healthLabel(deficit, offline);
    const badgeClass = (h.state === "good") ? "good" : "warn";

    return `
      <tr>
        <td>
          <div style="font-weight:950;">${escapeHtml(o.orgName || "Unknown")}</div>
          <div class="mono">${escapeHtml(o.orgId || "")}</div>
        </td>
        <td>${deficit}</td>
        <td>${offline}</td>
        <td>${escapeHtml(String(callVol))}</td>
        <td><span class="badge ${badgeClass}"><span class="dot ${h.state === "good" ? "good" : ""}"></span>${h.text}</span></td>
        <td class="right">
          <div class="actions">
            <button class="btn-xs" onclick="goPage('/admin/licenses','${escapeJs(o.orgId)}')">Licenses</button>
            <button class="btn-xs" onclick="goPage('/admin/devices','${escapeJs(o.orgId)}')">Devices</button>
            <button class="btn-xs" onclick="goPage('/admin/analytics','${escapeJs(o.orgId)}')">Analytics</button>
          </div>
        </td>
      </tr>
    `;
  }

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function escapeJs(str){
    return String(str ?? "").replaceAll("\\","\\\\").replaceAll("'","\\'");
  }

  function goPage(path, orgId){
    // persist selected org across pages
    if (orgId) localStorage.setItem("adminSelectedOrgId", orgId);
    window.location.href = path;
  }

  function setSessionTimer(seconds){
    if (!Number.isFinite(seconds) || seconds <= 0) {
      $("sessionLine").textContent = "Session: —";
      return;
    }
    let remaining = seconds;
    $("sessionLine").textContent = "Session: " + remaining + "s";
    const t = setInterval(()=>{
      remaining--;
      $("sessionLine").textContent = "Session: " + remaining + "s";
      if (remaining <= 0){
        clearInterval(t);
        window.location.href = "/pin?expired=1";
      }
    }, 1000);
  }

  async function loadOrgList(){
    const data = await api("/api/admin/orgs");
    if (!data) return [];
    const items = Array.isArray(data.items) ? data.items : [];
    const sel = $("orgSelect");

    // fill dropdown
    for (const o of items){
      const opt = document.createElement("option");
      opt.value = o.orgId;
      opt.textContent = o.orgName || o.orgId;
      sel.appendChild(opt);
    }

    // restore selection
    const saved = localStorage.getItem("adminSelectedOrgId") || "";
    if (saved) sel.value = saved;

    sel.onchange = () => {
      localStorage.setItem("adminSelectedOrgId", sel.value || "");
      refreshAll();
    };

    return items;
  }

  async function loadSnapshotIfAvailable(){
    // optional endpoint; if not present it will 404 and we ignore
    try{
      const snap = await api("/api/admin/global-summary");
      return snap && snap.ok ? snap : null;
    } catch(e){
      return null;
    }
  }

  async function loadHealth(items){
    const selectedOrgId = $("orgSelect").value || "";
    const scope = selectedOrgId ? items.filter(x => x.orgId === selectedOrgId) : items;

    if (!scope.length){
      $("tenantRows").innerHTML = `<tr><td colspan="6" class="loading">No tenants available.</td></tr>`;
      $("kpiOrgs").textContent = "0";
      $("kpiAttention").textContent = "0";
      $("kpiDeficits").textContent = "0";
      $("kpiOffline").textContent = "0";
      $("kpiCalls").textContent = "—";
      setHealthBadge("warn","No scope");
      return;
    }

    $("tenantRows").innerHTML = `<tr><td colspan="6" class="loading">Evaluating tenant health…</td></tr>`;

    const results = [];
    let totalDef = 0;
    let totalOff = 0;
    let attention = 0;

    // sequential to avoid subrequest explosions
    for (const o of scope){
      const r = await api(`/api/admin/org-health?orgId=${encodeURIComponent(o.orgId)}`);
      if (!r) continue;

      const deficit = Number(r.deficit || 0);
      const offline = Number(r.offline || 0);

      totalDef += deficit;
      totalOff += offline;
      if (deficit > 0 || offline > 0) attention++;

      results.push({
        orgId: o.orgId,
        orgName: o.orgName,
        deficit,
        offline,
        callVolume: "—"
      });
    }

    // KPIs
    $("kpiOrgs").textContent = String(scope.length);
    $("kpiAttention").textContent = String(attention);
    $("kpiDeficits").textContent = String(totalDef);
    $("kpiOffline").textContent = String(totalOff);
    $("kpiCalls").textContent = "—";

    // top badge
    if (attention === 0){
      setHealthBadge("good", selectedOrgId ? "Tenant Healthy" : "All Tenants Healthy");
    } else {
      setHealthBadge("warn", selectedOrgId ? "Tenant Needs Attention" : "Some Tenants Need Attention");
    }

    // render table (attention first)
    results.sort((a,b) => (b.deficit + b.offline) - (a.deficit + a.offline));
    $("tenantRows").innerHTML = results.map(renderRow).join("");

    $("lastUpdated").textContent = "Last Updated: " + new Date().toLocaleString();
  }

  async function refreshAll(){
    const me = await api("/api/me");
    if (!me || me.role !== "admin"){
      window.location.href = "/pin";
      return;
    }

    $("whoami").textContent = me.email || "Admin";
    setSessionTimer(me.sessionExpiresInSeconds || 0);

    const orgs = await loadOrgList();
    await loadHealth(orgs);
  }

  $("btnOpenCustomers").onclick = () => window.location.href = "/admin/customers";
  $("btnRefresh").onclick = () => refreshAll();
  $("btnLogout").onclick = async () => {
    await fetch("/api/pin/logout", { method:"POST" });
    window.location.href = "/pin";
  };

  refreshAll();
</script>

</body>
</html>
