<style>
.section-title{
  font-size:18px;
  font-weight:600;
  margin-bottom:15px;
}

.grid{
  display:grid;
  gap:20px;
}

.grid-4{
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
}

.card{
  background:var(--card);
  padding:20px;
  border-radius:12px;
  box-shadow:0 2px 12px rgba(0,0,0,0.05);
}

.card h3{
  margin:0 0 8px 0;
  font-size:14px;
  color:var(--muted);
}

.metric{
  font-size:28px;
  font-weight:600;
}

.danger{ color:var(--danger); }
.success{ color:var(--success); }

.table{
  width:100%;
  border-collapse:collapse;
}

.table th, .table td{
  padding:12px;
  border-bottom:1px solid rgba(0,0,0,0.08);
  text-align:left;
}

.loading{
  text-align:center;
  padding:40px;
  color:var(--muted);
}

input{
  padding:10px 12px;
  border-radius:10px;
  border:1px solid rgba(0,0,0,.18);
  background:var(--card);
  color:var(--text);
  font-size:14px;
  outline:none;
}

.btn-primary{
  background:var(--accent);
  color:#fff;
  border:none;
  border-radius:10px;
  padding:10px 12px;
  cursor:pointer;
  font-weight:800;
}

.btn-outline{
  background:transparent;
  color:var(--text);
  border:1px solid rgba(0,0,0,.22);
  border-radius:10px;
  padding:10px 12px;
  cursor:pointer;
  font-weight:700;
}

[data-theme="dark"] input{
  border-color: rgba(255,255,255,.14);
}

[data-theme="dark"] .btn-outline{
  border-color: rgba(255,255,255,.16);
}
</style>


<!-- ===============================
     EXECUTIVE SUMMARY
================================ -->

<div class="section-title">Executive Summary</div>

<div class="grid grid-4">

  <div class="card">
    <h3>Total Partner Orgs</h3>
    <div class="metric" id="totalOrgs">—</div>
  </div>

  <div class="card">
    <h3>License Deficits</h3>
    <div class="metric danger" id="totalDeficits">—</div>
  </div>

  <div class="card">
    <h3>Offline Devices</h3>
    <div class="metric danger" id="offlineDevices">—</div>
  </div>

  <div class="card">
    <h3>Total Call Volume (7d)</h3>
    <div class="metric success" id="totalCalls">—</div>
  </div>

  <div class="card">
    <h3>Total Customers</h3>
    <div class="metric success" id="totalCustomers">—</div>
  </div>

</div>

<br><br>


<!-- ===============================
     MULTI TENANT DASHBOARD
================================ -->

<div class="section-title">Multi-Tenant Health Dashboard</div>

<div class="card">
  <table class="table">
    <thead>
      <tr>
        <th>Organization</th>
        <th>License</th>
        <th>Devices</th>
        <th>Call Volume</th>
        <th>Health</th>
      </tr>
    </thead>
    <tbody id="tenantTable">
      <tr>
        <td colspan="5" class="loading">Loading tenants...</td>
      </tr>
    </tbody>
  </table>
</div>

<br><br>


<!-- ===============================
     PIN MANAGEMENT
================================ -->

<div class="section-title">PIN Management</div>

<div class="card">
  <button class="btn-primary" onclick="openPinManager()">
    Manage Tenant PINs
  </button>
</div>

<br><br>


<!-- ===============================
     TENANT RESOLUTION
================================ -->

<div class="section-title">Tenant Resolution Inspector</div>

<div class="card">
  <input id="inspectEmail" placeholder="Enter email" />
  <button class="btn-outline" onclick="resolveTenant()">Inspect</button>
  <pre id="inspectResult"></pre>
</div>


<!-- ===============================
     PIN MODAL
================================ -->

<div id="pinModal" style="
  position:fixed; inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:center; justify-content:center;
  z-index:9999;
  padding:40px;
">

  <div style="
    width:920px; max-width:95vw;
    background:var(--card);
    border-radius:16px;
    box-shadow:0 18px 60px rgba(0,0,0,.35);
    overflow:hidden;
    border:1px solid rgba(255,255,255,.06);
  ">

    <div style="
      display:flex; align-items:center; justify-content:space-between;
      padding:18px 20px;
      border-bottom:1px solid rgba(0,0,0,.08);
    ">
      <div>
        <div style="font-weight:800; font-size:16px;">PIN Management</div>
        <div style="color:var(--muted); font-size:13px; margin-top:4px;">
          Search tenants, rotate PINs, and manage email allowlists.
        </div>
      </div>

      <div style="display:flex; gap:10px;">
        <button class="btn-outline" onclick="refreshPinManager()">Refresh</button>
        <button class="btn-primary" onclick="closePinManager()">Close</button>
      </div>
    </div>

    <div style="padding:18px 20px;">
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <input id="pinSearch" placeholder="Search org name..." style="flex:1; min-width:280px;" />
        <button class="btn-outline" onclick="refreshPinManager()">Search</button>
      </div>

      <div id="pinMgrError" style="
        margin-top:12px; padding:10px 12px; border-radius:12px;
        border:1px solid rgba(0,0,0,.10);
        background:rgba(239,68,68,.10);
        display:none;
        white-space:pre-wrap;
        font-size:13px;
      "></div>

      <div style="height:12px"></div>

      <div style="
        overflow:auto;
        max-height:60vh;
        border-radius:12px;
        border:1px solid rgba(0,0,0,.08);
      ">
        <table style="width:100%; border-collapse:collapse;">
          <thead>
            <tr style="background:rgba(0,0,0,.03);">
              <th style="padding:12px;">Org</th>
              <th style="padding:12px;">Org ID</th>
              <th style="padding:12px;">PIN</th>
              <th style="padding:12px;">Allowlisted Emails</th>
              <th style="padding:12px; text-align:right;">Actions</th>
            </tr>
          </thead>
          <tbody id="pinMgrRows">
            <tr><td colspan="5" style="padding:18px;">Loading…</td></tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>
</div>


<script>

/* ===============================
   API Helper
================================ */

async function api(path){
  const res = await fetch(path);
  if (!res.ok){
    if (res.status === 401){
      window.location.href="/pin";
      return null;
    }
    throw new Error("API failed: "+path);
  }
  return await res.json();
}

/* ===============================
   Load Org List
================================ */

async function loadAdminSummary(){
  const data = await api("/api/admin/orgs");
  if (!data) return;

  document.getElementById("totalOrgs").textContent = data.items.length;
  document.getElementById("totalCustomers").textContent = data.items.length;

  const rows = data.items.map(o => `
    <tr id="row-${o.orgId}">
      <td>${o.orgName}</td>
      <td colspan="4">Loading...</td>
    </tr>
  `).join("");

  document.getElementById("tenantTable").innerHTML = rows;

  for (const o of data.items){
    loadOrgHealth(o.orgId, o.orgName);
  }
}

/* ===============================
   Load Per Org Health
================================ */

async function loadOrgHealth(orgId, orgName){
  const r = await api(`/api/admin/org-health?orgId=${orgId}`);
  if (!r) return;

  const row = document.getElementById(`row-${orgId}`);
  if (!row) return;

  row.innerHTML = `
    <td>${orgName}</td>
    <td>${r.deficit}</td>
    <td>${r.offline}</td>
    <td>—</td>
    <td>${r.deficit > 0 || r.offline > 0 ? "Attention" : "Healthy"}</td>
  `;
}

/* ===============================
   Init
================================ */

loadAdminSummary();

</script>
