<div class="page-header">
  <h2>License Management</h2>

  <div style="display:flex; gap:12px; align-items:center;">
    <select id="orgSelector"></select>

    <label style="display:flex; align-items:center; gap:6px; font-size:14px;">
      <input type="checkbox" id="auditToggle">
      Audit Mode
    </label>
  </div>
</div>

<!-- SLA Overview -->
<div class="kpi-row">

  <div class="kpi-card">
    <div class="kpi-label">Assigned</div>
    <div class="kpi-value" id="assignedCount">—</div>
  </div>

  <div class="kpi-card">
    <div class="kpi-label">Available</div>
    <div class="kpi-value" id="availableCount">—</div>
  </div>

  <div class="kpi-card">
    <div class="kpi-label">Deficit</div>
    <div class="kpi-value danger" id="deficitCount">—</div>
  </div>

  <div class="kpi-card">
    <div class="kpi-label">Utilization</div>
    <div class="kpi-value success" id="utilization">—</div>
  </div>

  <div class="kpi-card">
    <div class="kpi-label">SLA Compliance</div>
    <div class="kpi-value success" id="slaCompliance">—</div>
  </div>

</div>

<!-- License Table -->
<div class="card">
  <table class="table">
    <thead>
      <tr>
        <th>License SKU</th>
        <th>Assigned</th>
        <th>Total</th>
        <th>Utilization</th>
        <th>Status</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="licenseTable">
      <tr><td colspan="6">Select organization...</td></tr>
    </tbody>
  </table>
</div>

<!-- Multi-Tenant Drilldown Modal -->
<div id="licenseModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <h3 id="modalTitle">License Drilldown</h3>
      <button onclick="closeModal()">Close</button>
    </div>
    <div id="modalContent" class="modal-body"></div>
  </div>
</div>

<style>
.modal-overlay {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

.modal-card {
  width:800px;
  max-width:95%;
  background:var(--card);
  border-radius:14px;
  padding:24px;
}

.modal-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:16px;
}

.modal-body {
  max-height:60vh;
  overflow:auto;
  font-size:14px;
}
</style>

<script>
let currentOrg = null;

async function loadLicenses(orgId) {
  currentOrg = orgId;

  const data = await api(`/api/admin/licenses?orgId=${orgId}`);
  if (!data) return;

  const assigned = data.assigned || 0;
  const total = data.total || 0;
  const available = total - assigned;
  const deficit = assigned > total ? assigned - total : 0;
  const utilization = total ? Math.round((assigned / total) * 100) : 0;

  document.getElementById("assignedCount").textContent = assigned;
  document.getElementById("availableCount").textContent = available;
  document.getElementById("deficitCount").textContent = deficit;
  document.getElementById("utilization").textContent = utilization + "%";

  // SLA Logic
  const sla = deficit > 0 ? "At Risk" : "Compliant";
  const slaEl = document.getElementById("slaCompliance");
  slaEl.textContent = sla;
  slaEl.className = "kpi-value " + (deficit > 0 ? "danger" : "success");

  const rows = data.items.map(l => {

    const util = l.total
      ? Math.round((l.assigned / l.total) * 100)
      : 0;

    const status =
      l.assigned > l.total
        ? `<span class="danger">Deficit</span>`
        : `<span class="success">Healthy</span>`;

    return `
      <tr>
        <td>${l.sku}</td>
        <td>${l.assigned}</td>
        <td>${l.total}</td>
        <td>${util}%</td>
        <td>${status}</td>
        <td>
          <button onclick="openModal('${l.sku}')">
            Details
          </button>
        </td>
      </tr>
    `;
  }).join("");

  document.getElementById("licenseTable").innerHTML = rows;

  if (document.getElementById("auditToggle").checked) {
    applyAuditMode();
  }
}

function openModal(sku) {
  document.getElementById("modalTitle").textContent =
    `License Details – ${sku}`;

  document.getElementById("modalContent").innerHTML =
    `<p>Detailed breakdown for SKU: <strong>${sku}</strong></p>
     <p>Tenant: ${currentOrg}</p>
     <p>This view can include user-level assignments, compliance checks, and change history.</p>`;

  document.getElementById("licenseModal").style.display = "flex";
}

function closeModal() {
  document.getElementById("licenseModal").style.display = "none";
}

function applyAuditMode() {
  document.querySelectorAll("#licenseTable tr").forEach(row => {
    row.style.background =
      row.innerHTML.includes("Deficit")
        ? "rgba(220,38,38,0.08)"
        : "";
  });
}

document.getElementById("auditToggle").onchange = () => {
  if (currentOrg) loadLicenses(currentOrg);
};

document.getElementById("orgSelector").onchange = e => {
  loadLicenses(e.target.value);
};
</script>
