<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8" />
<title>US Signal | Webex Incidents</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
/* =========================================================
   US SIGNAL – WEBEX STYLE INCIDENT VIEW
   Matches Maintenance UI
========================================================= */

:root{
  --bg:#f6f8fb;
  --card:#ffffff;
  --border:#e6edf6;
  --text:#0f172a;
  --muted:#64748b;
  --accent:#2563eb;
  --greenRow:#e6f3df;
  --rowHover:#f2f7ff;
  --shadow:0 10px 26px rgba(15,23,42,.08);
}

html[data-theme="dark"]{
  --bg:#0b1220;
  --card:#0f172a;
  --border:#1f2a3a;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --accent:#3b82f6;
  --greenRow:rgba(40,80,40,.4);
  --rowHover:rgba(59,130,246,.10);
}

*{ box-sizing:border-box; font-family:system-ui,-apple-system,Segoe UI,Roboto; }
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
}

/* ================= HEADER ================= */
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:18px 24px;
  background:var(--card);
  border-bottom:1px solid var(--border);
}

.logo{
  display:flex;
  align-items:center;
  gap:12px;
}

.logo img{
  height:38px;
}

.header h1{
  margin:0;
  font-size:18px;
  font-weight:800;
}

.actions{
  display:flex;
  gap:10px;
}

.btn{
  padding:9px 14px;
  border-radius:12px;
  border:1px solid var(--border);
  background:transparent;
  font-weight:700;
  cursor:pointer;
}

.btn.primary{
  background:var(--accent);
  color:#fff;
  border:none;
}

/* ================= TABLE ================= */

.panel{
  margin:20px;
  background:var(--card);
  border-radius:16px;
  box-shadow:var(--shadow);
  border:1px solid var(--border);
  overflow:hidden;
}

table{
  width:100%;
  border-collapse:collapse;
}

thead th{
  text-align:left;
  font-size:12px;
  text-transform:uppercase;
  color:var(--muted);
  padding:14px;
  border-bottom:1px solid var(--border);
}

tbody td{
  padding:14px;
  border-bottom:1px solid var(--border);
  vertical-align:top;
}

.dataRow{
  cursor:pointer;
  transition:.2s;
}

.dataRow:hover{
  background:var(--rowHover);
}

.dataRow.expanded{
  background:var(--greenRow);
}

.badge{
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:700;
}

.badge.investigating{ background:#fef3c7; color:#92400e; }
.badge.identified{ background:#dbeafe; color:#1e3a8a; }
.badge.monitoring{ background:#e0f2fe; color:#075985; }
.badge.resolved{ background:#dcfce7; color:#166534; }

.expandArrow{
  transition:transform .2s;
  display:inline-block;
}

.dataRow.expanded .expandArrow{
  transform:rotate(90deg);
}

/* ================= DETAIL ================= */

.detailRow{
  display:none;
}

.detailCard{
  padding:20px;
  background:#fafcff;
}

.timelineItem{
  margin-bottom:16px;
}

.timelineItem strong{
  display:block;
  margin-bottom:6px;
}

.emailBtn{
  padding:6px 10px;
  border-radius:8px;
  background:var(--accent);
  color:#fff;
  font-size:12px;
  border:none;
  cursor:pointer;
}

.redirectBtn{
  margin-top:14px;
  padding:8px 14px;
  border-radius:10px;
  background:#111;
  color:#fff;
  font-weight:600;
  border:none;
  cursor:pointer;
}

</style>
</head>

<body>

<div class="header">
  <div class="logo">
    <img src="https://webex.onenecklab.com/assets/ussignal-logo.jpg" />
    <h1>Webex Incidents</h1>
  </div>

  <div class="actions">
    <button class="btn" onclick="toggleTheme()">Toggle Theme</button>
    <button class="btn primary" onclick="loadIncidents(true)">Refresh</button>
  </div>
</div>

<div class="panel">
  <table>
    <thead>
      <tr>
        <th>Reference #</th>
        <th>Occur Date</th>
        <th>Location</th>
        <th>Sector</th>
        <th>Webex Service</th>
        <th>Description</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="incidentBody">
      <tr><td colspan="7">Loading...</td></tr>
    </tbody>
  </table>
</div>

<script>

/* ================= THEME ================= */
function toggleTheme(){
  const html=document.documentElement;
  const cur=html.getAttribute("data-theme");
  html.setAttribute("data-theme",cur==="dark"?"light":"dark");
}

/* ================= FETCH ================= */

async function fetchIncidents(){
  const res=await fetch("/api/incidents",{cache:"no-store"});
  if(!res.ok) return null;
  return await res.json();
}

/* ================= RENDER ================= */

async function loadIncidents(force){

  const data=await fetchIncidents();
  if(!data){
    document.getElementById("incidentBody").innerHTML=
      `<tr><td colspan="7">Unable to load incidents.</td></tr>`;
    return;
  }

  const items=data.incidents||[];

  let html="";

  items.forEach((i,index)=>{

    const id=`detail-${index}`;
    const ref=i.externalId||"—";
    const date=i.created_at?new Date(i.created_at).toLocaleString():"—";
    const location=i.location||"—";
    const sector=i.sector||"Commercial";
    const service=(i.components||[]).map(c=>c.name).join(", ");
    const desc=i.name||"—";

    html+=`
      <tr class="dataRow" onclick="toggleDetail('${id}',this)">
        <td>${ref}</td>
        <td>${date}</td>
        <td>${location}</td>
        <td>${sector}</td>
        <td>${service}</td>
        <td>${desc}</td>
        <td><span class="expandArrow">▶</span></td>
      </tr>

      <tr id="${id}" class="detailRow">
        <td colspan="7">
          <div class="detailCard">

            ${(i.updates||[]).map(u=>`
              <div class="timelineItem">
                <strong>${u.status}</strong>
                ${u.body||""}
                <div style="font-size:12px;color:#64748b;margin-top:6px;">
                  ${u.created_at?new Date(u.created_at).toLocaleString():""}
                </div>
              </div>
            `).join("")}

            <button class="emailBtn"
              onclick="event.stopPropagation();notify('${i.id}')">
              Email Update
            </button>

            <button class="redirectBtn"
              onclick="window.open('https://status.webex.com/incident/history?lang=en_US','_blank')">
              View on Webex Status
            </button>

          </div>
        </td>
      </tr>
    `;
  });

  document.getElementById("incidentBody").innerHTML=html;
}

/* ================= TOGGLE ================= */

function toggleDetail(id,row){
  const detail=document.getElementById(id);
  const isOpen=detail.style.display==="table-row";

  document.querySelectorAll(".detailRow").forEach(d=>d.style.display="none");
  document.querySelectorAll(".dataRow").forEach(r=>r.classList.remove("expanded"));

  if(!isOpen){
    detail.style.display="table-row";
    row.classList.add("expanded");
  }
}

/* ================= EMAIL ================= */

async function notify(id){
  const email=prompt("Enter your email address:");
  if(!email) return;

  await fetch("/api/incidents/notify",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({incidentId:id,email})
  });

  alert("Notification request sent.");
}

loadIncidents(false);

</script>

</body>
</html>
