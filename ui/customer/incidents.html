<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8"/>
<title>US Signal | Webex Incidents</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<style>
/* =======================================================
   US SIGNAL – ENTERPRISE INCIDENT DASHBOARD
======================================================= */

:root{
  --bg:#f4f7fb;
  --sidebar:#ffffff;
  --card:#ffffff;
  --border:#e5edf6;
  --text:#0f172a;
  --muted:#64748b;
  --accent:#2563eb;
  --green:#16a34a;
  --yellow:#f59e0b;
  --red:#dc2626;
  --rowHover:#f2f7ff;
  --expanded:#eaf3ff;
  --shadow:0 12px 28px rgba(15,23,42,.08);
}

html[data-theme="dark"]{
  --bg:#0b1220;
  --sidebar:#0f172a;
  --card:#111827;
  --border:#1f2a3a;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --rowHover:rgba(59,130,246,.12);
  --expanded:rgba(59,130,246,.18);
}

*{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto;}

body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  display:flex;
  min-height:100vh;
}

/* ================= SIDEBAR ================= */

.sidebar{
  width:220px;
  background:var(--sidebar);
  border-right:1px solid var(--border);
  padding:24px 16px;
}

.sidebar img{
  width:150px;
  margin-bottom:30px;
}

.nav-link{
  display:block;
  padding:10px 12px;
  border-radius:8px;
  text-decoration:none;
  color:var(--text);
  font-weight:600;
  margin-bottom:8px;
}

.nav-link:hover{
  background:var(--rowHover);
}

/* ================= MAIN ================= */

.main{
  flex:1;
  display:flex;
  flex-direction:column;
}

/* Header */

.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:20px 28px;
  background:var(--card);
  border-bottom:1px solid var(--border);
}

.topbar h1{
  margin:0;
  font-size:20px;
  font-weight:800;
}

.actions{
  display:flex;
  gap:10px;
}

.btn{
  padding:8px 14px;
  border-radius:10px;
  border:1px solid var(--border);
  background:transparent;
  font-weight:600;
  cursor:pointer;
}

.btn.primary{
  background:var(--accent);
  color:#fff;
  border:none;
}

/* ================= DASHBOARD SUMMARY ================= */

.summary{
  display:flex;
  gap:20px;
  padding:20px 28px;
}

.summaryCard{
  flex:1;
  background:var(--card);
  border-radius:16px;
  padding:20px;
  border:1px solid var(--border);
  box-shadow:var(--shadow);
}

.summaryCard h3{
  margin:0 0 8px;
  font-size:14px;
  color:var(--muted);
}

.summaryCard .value{
  font-size:28px;
  font-weight:800;
}

/* ================= TABLE ================= */

.panel{
  margin:0 28px 28px;
  background:var(--card);
  border-radius:16px;
  border:1px solid var(--border);
  box-shadow:var(--shadow);
  overflow:hidden;
}

table{
  width:100%;
  border-collapse:collapse;
}

thead th{
  text-align:left;
  font-size:12px;
  text-transform:uppercase;
  color:var(--muted);
  padding:14px;
  border-bottom:1px solid var(--border);
}

tbody td{
  padding:14px;
  border-bottom:1px solid var(--border);
  vertical-align:top;
}

.dataRow{
  cursor:pointer;
  transition:.2s;
}

.dataRow:hover{
  background:var(--rowHover);
}

.dataRow.expanded{
  background:var(--expanded);
}

.badge{
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:700;
}

.active{ background:#fee2e2;color:#991b1b; }
.resolved{ background:#dcfce7;color:#166534; }

.expandArrow{
  display:inline-block;
  transition:.2s;
}

.dataRow.expanded .expandArrow{
  transform:rotate(90deg);
}

/* Detail Row */

.detailRow{
  display:none;
}

.detailCard{
  padding:20px;
  background:#fafcff;
}

.timelineItem{
  margin-bottom:16px;
}

.timelineItem strong{
  display:block;
  margin-bottom:6px;
}

</style>
</head>
<body>

<!-- ================= SIDEBAR ================= -->
<div class="sidebar">
  <img src="https://webex.onenecklab.com/assets/ussignal-logo.jpg"/>
  <a class="nav-link" href="/customer">Dashboard</a>
  <a class="nav-link" href="/customer/status">Status</a>
  <a class="nav-link" href="/customer/maintenance">Maintenance</a>
  <a class="nav-link" href="/customer/incidents">Incidents</a>
</div>

<!-- ================= MAIN ================= -->
<div class="main">

  <div class="topbar">
    <h1>Webex Incidents</h1>
    <div class="actions">
      <button class="btn" onclick="toggleTheme()">Toggle Theme</button>
      <button class="btn primary" onclick="loadIncidents()">Refresh</button>
    </div>
  </div>

  <!-- Summary -->
  <div class="summary">
    <div class="summaryCard">
      <h3>Active Incidents</h3>
      <div class="value" id="activeCount">0</div>
    </div>
    <div class="summaryCard">
      <h3>Resolved Incidents</h3>
      <div class="value" id="resolvedCount">0</div>
    </div>
    <div class="summaryCard">
      <h3>Total Incidents</h3>
      <div class="value" id="totalCount">0</div>
    </div>
  </div>

  <!-- Table -->
  <div class="panel">
    <table>
      <thead>
        <tr>
          <th>Reference</th>
          <th>Status</th>
          <th>Date</th>
          <th>Services</th>
          <th>Description</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="incidentBody">
        <tr><td colspan="6">Loading...</td></tr>
      </tbody>
    </table>
  </div>

</div>

<script>

/* ================= THEME ================= */
function toggleTheme(){
  const html=document.documentElement;
  const cur=html.getAttribute("data-theme");
  html.setAttribute("data-theme",cur==="dark"?"light":"dark");
}

/* ================= FETCH ================= */

async function fetchIncidents(){
  const res=await fetch("/api/incidents",{cache:"no-store"});
  if(!res.ok) return null;
  return await res.json();
}

/* ================= LOAD ================= */

async function loadIncidents(){

  const data=await fetchIncidents();
  if(!data) return;

  const items=data.incidents||[];

  const activeStatuses=["investigating","identified","monitoring"];
  const active=items.filter(i=>activeStatuses.includes((i.status||"").toLowerCase()));
  const resolved=items.filter(i=>(i.status||"").toLowerCase()==="resolved");

  document.getElementById("activeCount").textContent=active.length;
  document.getElementById("resolvedCount").textContent=resolved.length;
  document.getElementById("totalCount").textContent=items.length;

  let html="";

  items.forEach((i,index)=>{

    const id=`detail-${index}`;
    const status=(i.status||"").toLowerCase();
    const isActive=activeStatuses.includes(status);

    html+=`
      <tr class="dataRow" onclick="toggleDetail('${id}',this)">
        <td>${i.external_id||i.id||"—"}</td>
        <td>
          <span class="badge ${isActive?"active":"resolved"}">
            ${isActive?"Active":"Resolved"}
          </span>
        </td>
        <td>${i.created_at?new Date(i.created_at).toLocaleString():"—"}</td>
        <td>${(i.components||[]).map(c=>c.name).join(", ")}</td>
        <td>${i.name||"—"}</td>
        <td><span class="expandArrow">▶</span></td>
      </tr>

      <tr id="${id}" class="detailRow">
        <td colspan="6">
          <div class="detailCard">
            ${(i.incident_updates||i.updates||[]).map(u=>`
              <div class="timelineItem">
                <strong>${u.status}</strong>
                ${u.body||""}
                <div style="font-size:12px;color:#64748b;">
                  ${u.created_at?new Date(u.created_at).toLocaleString():""}
                </div>
              </div>
            `).join("")}

            <button class="btn primary"
              onclick="event.stopPropagation();window.open('https://status.webex.com/incident/history?lang=en_US','_blank')">
              View on Webex Status
            </button>
          </div>
        </td>
      </tr>
    `;
  });

  document.getElementById("incidentBody").innerHTML=html;
}

/* ================= TOGGLE ================= */

function toggleDetail(id,row){
  const detail=document.getElementById(id);
  const isOpen=detail.style.display==="table-row";

  document.querySelectorAll(".detailRow").forEach(d=>d.style.display="none");
  document.querySelectorAll(".dataRow").forEach(r=>r.classList.remove("expanded"));

  if(!isOpen){
    detail.style.display="table-row";
    row.classList.add("expanded");
  }
}

loadIncidents();

</script>

</body>
</html>
