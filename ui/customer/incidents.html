<!-- =========================================================
     INCIDENT INTELLIGENCE 3.0
     Fortune-100 NOC Architecture
     Fully aligned with License Intelligence 2.0 layout
========================================================= -->
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8"/>
<title>US Signal | Incident Intelligence 3.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<style>
/* ========= EXACT SAME TOKEN SYSTEM AS LICENSE 2.0 ========= */
:root{
  --bg:#f6f8fb;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#64748b;
  --line:rgba(15,23,42,.10);
  --shadow:0 8px 24px rgba(15,23,42,.08);
  --accent:#0f62fe;
  --good:#16a34a;
  --warn:#f59e0b;
  --bad:#dc2626;
  --pillBg:#fff;
  --pillBorder:rgba(15,23,42,.14);
}
html[data-theme="dark"]{
  --bg:#0b1220;
  --card:#0f172a;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --line:rgba(226,232,240,.12);
  --shadow:0 12px 32px rgba(0,0,0,.35);
  --accent:#3b82f6;
  --good:#22c55e;
  --warn:#f59e0b;
  --bad:#ef4444;
  --pillBg:rgba(15,23,42,.35);
  --pillBorder:rgba(226,232,240,.14);
}
*{box-sizing:border-box;font-family:system-ui;}
body{margin:0;background:var(--bg);color:var(--text);display:flex;min-height:100vh;}

/* ===== SIDEBAR IDENTICAL STRUCTURE ===== */
.sidebar{
  width:270px;background:var(--card);
  border-right:1px solid var(--line);
  padding:18px 14px;
  display:flex;flex-direction:column;gap:14px;
}
.brand{display:flex;gap:12px;padding-bottom:14px;border-bottom:1px solid var(--line);}
.brand img{height:34px;}
.nav{display:flex;flex-direction:column;gap:6px;}
.nav a{
  padding:10px;border-radius:12px;
  text-decoration:none;font-weight:800;
  font-size:13px;color:var(--text);
}
.nav a:hover{background:rgba(15,98,254,.12);}
.nav a.active{background:rgba(15,98,254,.18);border:1px solid rgba(15,98,254,.25);}
.sidebarFooter{margin-top:auto;padding-top:12px;border-top:1px solid var(--line);}
.ragPill{
  padding:10px;border-radius:999px;
  border:1px solid var(--pillBorder);
  display:flex;justify-content:space-between;
  font-weight:1000;
}
.ragDot{width:10px;height:10px;border-radius:50%;background:var(--good);}
.sideBtnRow{display:flex;gap:10px;margin-top:10px;}
.sideBtnRow button{width:100%;}

/* ===== MAIN LAYOUT ===== */
.main{flex:1;padding:22px;display:flex;flex-direction:column;gap:18px;}
.header-card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:16px;
  box-shadow:var(--shadow);
  padding:16px;
  display:flex;justify-content:space-between;
}
.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:16px;
  box-shadow:var(--shadow);
  padding:16px;
}
.kpi-grid{
  display:grid;grid-template-columns:repeat(4,1fr);
  gap:12px;
}
.kpi{border:1px solid var(--line);border-radius:16px;padding:12px;}
.kpi .label{font-size:12px;color:var(--muted);font-weight:900;}
.kpi .value{font-size:18px;font-weight:1000;margin-top:6px;}
.banner{
  padding:12px;border-radius:12px;
  font-weight:900;
}
.banner.bad{background:rgba(220,38,38,.12);border:1px solid rgba(220,38,38,.35);color:var(--bad);}
.banner.warn{background:rgba(245,158,11,.12);border:1px solid rgba(245,158,11,.35);color:var(--warn);}
.table-wrap{border:1px solid var(--line);border-radius:16px;overflow:auto;}
table{width:100%;border-collapse:collapse;}
th,td{padding:12px;border-top:1px solid rgba(15,23,42,.06);}
th{text-align:left;font-size:12px;color:var(--muted);}
tr:hover{background:rgba(15,98,254,.05);cursor:pointer;}
.badge{padding:6px 10px;border-radius:999px;font-size:11px;font-weight:900;}
.badge.good{color:var(--good);}
.badge.warn{color:var(--warn);}
.badge.bad{color:var(--bad);}
button{
  background:var(--accent);color:#fff;border:none;
  padding:8px 14px;border-radius:10px;font-weight:900;cursor:pointer;
}
.btn-outline{background:transparent;border:1px solid var(--line);color:var(--text);}
canvas{width:100%;height:220px;}
.modalOverlay{
  position:fixed;inset:0;background:rgba(0,0,0,.6);
  display:none;align-items:center;justify-content:center;
}
.modal{
  background:var(--card);
  width:900px;max-width:95%;
  border-radius:16px;border:1px solid var(--line);
  padding:18px;max-height:90vh;overflow:auto;
}
</style>
</head>

<body>

<!-- SIDEBAR -->
<div class="sidebar">
  <div>
    <div class="brand">
      <img src="https://webex.onenecklab.com/assets/ussignal-logo.jpg"/>
      <div>
        <b>US Signal</b><br/>
        <span style="font-size:12px;color:var(--muted);">Customer Portal</span>
      </div>
    </div>
    <div class="nav">
      <a href="/customer">Dashboard</a>
      <a href="/customer/licenses">Licenses</a>
      <a href="/customer/devices">Devices</a>
      <a href="/customer/analytics">Analytics</a>
      <a href="/customer/cdr">CDR</a>
      <a href="/customer/pstn">PSTN</a>
      <a href="/customer/incidents" class="active">Incidents</a>
    </div>
  </div>
  <div class="sidebarFooter">
    <div class="ragPill">
      <span id="ragText">GREEN</span>
      <span id="ragScore">100</span>
    </div>
    <div class="sideBtnRow">
      <button class="btn-outline" onclick="toggleTheme()">Theme</button>
      <button class="btn-outline" onclick="logout()">Logout</button>
    </div>
  </div>
</div>

<!-- MAIN -->
<div class="main">

<div class="header-card">
  <div>
    <div style="font-weight:1000;font-size:16px;">Webex Incident Intelligence 3.0</div>
    <div style="font-size:12px;color:var(--muted);" id="execSummary"></div>
  </div>
  <div>
    <button class="btn-outline" onclick="exportPDF()">Export PDF</button>
    <button onclick="refreshData()">Refresh</button>
  </div>
</div>

<div id="slaBanner"></div>

<div class="kpi-grid">
  <div class="kpi"><div class="label">Active</div><div class="value" id="kActive">0</div></div>
  <div class="kpi"><div class="label">Major</div><div class="value" id="kMajor">0</div></div>
  <div class="kpi"><div class="label">MTTR</div><div class="value" id="kMTTR">0h</div></div>
  <div class="kpi"><div class="label">Impact Index</div><div class="value" id="kImpact">0</div></div>
</div>

<div class="card">
  <h3>30-Day Incident Trend</h3>
  <canvas id="trendChart"></canvas>
</div>

<div class="card">
  <h3>Incident Inventory</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Status</th>
          <th>Severity</th>
          <th>Start</th>
          <th>Products</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody id="incidentRows"></tbody>
    </table>
  </div>
</div>

</div>

<!-- MODAL -->
<div class="modalOverlay" id="incidentModal">
  <div class="modal">
    <h3 id="modalTitle"></h3>
    <div id="modalBody"></div>
    <div style="margin-top:10px;text-align:right;">
      <button class="btn-outline" onclick="closeModal()">Close</button>
    </div>
  </div>
</div>

<script>
let INCIDENTS=[];

async function refreshData(){
  const r=await fetch("/api/incidents",{cache:"no-store"});
  const data=await r.json();
  INCIDENTS=data.incidents||[];
  computeMetrics();
  renderTable();
}

function computeMetrics(){
  const active=INCIDENTS.filter(i=>i.status!=="resolved");
  const major=INCIDENTS.filter(i=>(i.impact||"").toLowerCase().includes("major"));
  document.getElementById("kActive").textContent=active.length;
  document.getElementById("kMajor").textContent=major.length;

  let impact=0;
  active.forEach(i=>{
    const sev=(i.impact||"").toLowerCase();
    if(sev.includes("major")) impact+=5;
    else if(sev.includes("partial")) impact+=3;
    else impact+=1;
  });
  document.getElementById("kImpact").textContent=impact;

  let mttr=0,count=0;
  INCIDENTS.filter(i=>i.status==="resolved").forEach(i=>{
    const start=new Date(i.created_at);
    const end=new Date(i.resolved_at||i.updated_at||Date.now());
    mttr+=(end-start);
    count++;
  });
  if(count>0){
    mttr=Math.round((mttr/count)/3600000);
  }
  document.getElementById("kMTTR").textContent=mttr+"h";

  updateRAG(impact);
  buildExecutive(active.length,major.length,impact);
}

function updateRAG(score){
  const rag=document.getElementById("ragText");
  const ragScore=document.getElementById("ragScore");
  ragScore.textContent=score;
  if(score>12){rag.textContent="RED";}
  else if(score>4){rag.textContent="AMBER";}
  else{rag.textContent="GREEN";}
}

function buildExecutive(a,m,impact){
  let txt="System operating normally.";
  if(a>0){
    txt=`${a} active incident(s). `;
    if(m>0) txt+=`${m} major severity. `;
    txt+=`Impact index ${impact}. Service degradation possible depending on tenant configuration.`;
  }
  document.getElementById("execSummary").textContent=txt;
}

function renderTable(){
  const tbody=document.getElementById("incidentRows");
  tbody.innerHTML="";
  INCIDENTS.forEach(i=>{
    const row=document.createElement("tr");
    row.innerHTML=`
      <td>${i.external_id||i.id}</td>
      <td>${i.status}</td>
      <td>${i.impact||""}</td>
      <td>${new Date(i.created_at).toLocaleString()}</td>
      <td>${(i.components||[]).map(c=>c.name).join(", ")}</td>
      <td>${i.name}</td>
    `;
    row.onclick=()=>openModal(i);
    tbody.appendChild(row);
  });
}

function openModal(i){
  document.getElementById("incidentModal").style.display="flex";
  document.getElementById("modalTitle").textContent=i.name;
  document.getElementById("modalBody").innerHTML=`
    <b>Status:</b> ${i.status}<br/>
    <b>Impact:</b> ${i.impact}<br/>
    <b>Created:</b> ${new Date(i.created_at).toLocaleString()}<br/><br/>
    ${(i.updates||[]).map(u=>`
      <div style="margin-bottom:10px;">
        <b>${u.status}</b><br/>
        ${u.body_html||u.body||""}<br/>
        <span style="font-size:11px;color:var(--muted);">${new Date(u.created_at).toLocaleString()}</span>
      </div>
    `).join("")}
  `;
}

function closeModal(){document.getElementById("incidentModal").style.display="none";}
function exportPDF(){window.print();}
function toggleTheme(){
  const html=document.documentElement;
  html.setAttribute("data-theme",html.getAttribute("data-theme")==="dark"?"light":"dark");
}
function logout(){window.location.href="/pin";}

refreshData();
</script>

</body>
</html>
