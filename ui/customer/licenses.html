<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8" />
<title>US Signal | Webex Calling License Management</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>

/* ======================================================
   THEME (MATCH INDEX)
====================================================== */

:root{
  --bg:#f6f8fb;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#64748b;
  --line:rgba(15,23,42,.10);
  --shadow:0 8px 24px rgba(15,23,42,.08);

  --accent:#0f62fe;
  --accent2:#0b4bd4;

  --good:#16a34a;
  --warn:#f59e0b;
  --bad:#dc2626;
}

*{ box-sizing:border-box; }

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  background:var(--bg);
  color:var(--text);
  display:flex;                 /* ðŸ”´ CRITICAL */
  min-height:100vh;
}

/* ======================================================
   SIDEBAR (IDENTICAL TO INDEX)
====================================================== */

.sidebar{
  width:270px;
  background:var(--card);
  border-right:1px solid var(--line);
  padding:18px 14px;
  display:flex;
  flex-direction:column;
  gap:14px;
}

.brand{
  display:flex;
  align-items:center;
  gap:12px;
  padding-bottom:14px;
  border-bottom:1px solid var(--line);
}

.brand img{ height:34px; }

.brand .title{
  display:flex;
  flex-direction:column;
}
.brand .title b{ font-size:14px; }
.brand .title span{
  font-size:12px;
  color:var(--muted);
}

.nav{
  display:flex;
  flex-direction:column;
  gap:6px;
}

.nav a{
  padding:10px;
  border-radius:12px;
  font-weight:800;
  font-size:13px;
  text-decoration:none;
  color:var(--text);
}

.nav a:hover{
  background:rgba(15,98,254,.08);
  color:var(--accent2);
}

.nav a.active{
  background:rgba(15,98,254,.12);
  border:1px solid rgba(15,98,254,.20);
}

/* ======================================================
   MAIN AREA
====================================================== */

.main{
  flex:1;
  padding:22px;
  display:flex;
  flex-direction:column;
}

/* Header Card (MATCH INDEX) */
.header-card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:16px;
  box-shadow:var(--shadow);
  padding:16px;
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:12px;
}

.header-left{
  display:flex;
  flex-direction:column;
  gap:4px;
}
.header-left .h{
  font-size:16px;
  font-weight:1000;
}
.header-left .sub{
  font-size:12px;
  color:var(--muted);
}

.header-actions{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}

.pill{
  padding:8px 10px;
  border-radius:999px;
  border:1px solid rgba(15,23,42,.14);
  background:#fff;
  font-size:12px;
  font-weight:900;
  color:var(--muted);
}

/* ======================================================
   CONTENT SECTIONS
====================================================== */

.section{ margin-top:18px; }

.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:16px;
  box-shadow:var(--shadow);
  padding:16px;
}

h2{
  margin:0 0 10px 0;
  font-size:14px;
  font-weight:1000;
}

.muted{
  font-size:12px;
  color:var(--muted);
}

.row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
}

.tabs{
  display:flex;
  gap:8px;
  margin-top:18px;
  border-bottom:1px solid var(--line);
}

.tab{
  padding:10px 16px;
  background:transparent;
  border:none;
  cursor:pointer;
  font-weight:900;
  border-bottom:3px solid transparent;
  color:var(--muted);
}

.tab.active{
  border-bottom:3px solid var(--accent);
  color:var(--accent);
}

.tabpanel.hidden{ display:none; }

.table-wrap{
  margin-top:10px;
  border:1px solid var(--line);
  border-radius:16px;
  overflow:auto;
}

table{
  width:100%;
  border-collapse:collapse;
}
thead th{
  padding:12px;
  font-size:12px;
  color:var(--muted);
  text-transform:uppercase;
}
tbody td{
  padding:12px;
  border-top:1px solid rgba(15,23,42,.06);
  font-size:13px;
}
tbody tr:hover{
  background:rgba(15,98,254,.04);
}

.hidden{ display:none !important; }
body {
  display: flex;
  min-height: 100vh;
}

.app {
  display: contents;
}
/* Spinner */
.spinner {
  width:14px;
  height:14px;
  border:2px solid rgba(255,255,255,.4);
  border-top:2px solid #fff;
  border-radius:50%;
  animation: spin .6s linear infinite;
  display:inline-block;
  vertical-align:middle;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Button polish */
button {
  background:var(--accent);
  color:#fff;
  border:none;
  padding:8px 14px;
  border-radius:10px;
  font-weight:800;
  cursor:pointer;
}

button:disabled {
  opacity:.65;
  cursor:not-allowed;
}
   /* Smooth status message */
.status-message {
  opacity:0;
  transition:opacity .25s ease;
}

.status-message.show {
  opacity:1;
}

/* Success state */
button.success {
  background:var(--good);
}

/* Input validation */
input.error {
  border:1px solid var(--bad);
}

/* Better input styling */
input[type="email"] {
  padding:8px 12px;
  border-radius:10px;
  border:1px solid var(--line);
  font-size:13px;
}
   .right {
  text-align: right;
}
   .right { text-align:right; }
</style>
</head>

<body>

<!-- ============================= -->
<!-- SIDEBAR -->
<!-- ============================= -->

<div class="sidebar">

  <div class="brand">
    <img src="https://webex.onenecklab.com/assets/ussignal-logo.jpg" />
    <div class="title">
      <b>US Signal</b>
      <span>Customer Portal</span>
    </div>
  </div>

  <div class="nav">
    <a href="/customer">Dashboard</a>
    <a href="/customer/licenses" class="active">Licenses</a>
    <a href="/customer/devices">Devices</a>
    <a href="/customer/analytics">Analytics</a>
    <a href="/customer/cdr">CDR</a>
    <a href="/customer/maintenance">Maintenance</a>
    <a href="/customer/status">Status</a>
    <a href="/customer/incidents">Incidents</a>
  </div>

</div>

<!-- ============================= -->
<!-- MAIN -->
<!-- ============================= -->

<div class="main">

  <!-- HEADER -->
  <div class="header-card">
    <div class="header-left">
      <div class="h">Webex Calling â€” License Management</div>
      <div class="sub" id="whoLine">Loadingâ€¦</div>
    </div>

    <div class="header-actions">
      <div class="pill" id="tenantPill">Tenant: â€”</div>
      <button class="btn-outline" id="btnTheme">Dark Mode</button>
      <button class="btn-outline" id="btnRefresh">Refresh</button>
    </div>
  </div>

  <!-- ============================= -->
  <!-- TENANT CONTEXT -->
  <!-- ============================= -->

  <div class="section">

    <div id="admin-note" class="card hidden">
      <b>US Signal Admin View</b>
      <div class="muted">
        You can switch tenants using the selector below.
      </div>
    </div>

    <div class="card">
      <h2>Tenant Context</h2>
      <div class="muted" id="orgContext">Loadingâ€¦</div>

      <div style="height:12px"></div>

      <div class="row">
        <select id="tenantSelect" disabled>
          <option>Loading tenantsâ€¦</option>
        </select>
        <button id="btnLoad">Load Licenses</button>
      </div>

      <div class="muted hidden" id="errBox"></div>
    </div>

  </div>

  <!-- ============================= -->
  <!-- TABS -->
  <!-- ============================= -->

  <div class="tabs">
    <button class="tab active" data-tab="licenses">Licenses</button>
    <button class="tab" data-tab="devices">Devices</button>
    <button class="tab" data-tab="analytics">Analytics</button>
    <button class="tab" data-tab="cdr">CDR</button>
     <button class="tab" data-tab="pstn">PSTN</button>
  </div>

  <!-- ============================= -->
  <!-- LICENSES TAB -->
  <!-- ============================= -->

  <section id="tab-licenses" class="tabpanel">

    <div class="section">
      <div class="card">
        <h2>Deficient SKUs</h2>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>SKU</th>
                <th>Available</th>
                <th>Total</th>
                <th>Used</th>
                <th>Needed</th>
              </tr>
            </thead>
            <tbody id="deficitRows">
              <tr><td colspan="5" class="muted">Loadingâ€¦</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="card">
        <h2>Current License Usage</h2>
        <div id="licenseLoading" class="muted">Loadingâ€¦</div>
        <div class="table-wrap">
          <table id="licenseTable" class="hidden">
            <thead>
              <tr>
                <th>SKU</th>
                <th>Total</th>
                <th>Used</th>
                <th>Available</th>
                <th>Deficit</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="licenseRows"></tbody>
          </table>
        </div>
      </div>
    </div>
     <div class="section">
  <div class="card">
    <h2>Email License Report</h2>

    <div class="row">
      <input
        id="reportEmail"
        type="email"
        placeholder="Enter email address"
        style="min-width:260px;"
      />
      <button id="btnSendEmail">Send Report</button>
    </div>

    <div id="emailStatus" class="muted status-message" style="margin-top:8px;"></div>
  </div>
</div>
  </section>  


      <!-- DEVICES TAB -->
      <section id="tab-devices" class="tabpanel hidden">
        <div class="card">

          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
            <h2 style="margin:0;">Devices</h2>
            <div class="muted" id="deviceSummary">â€”</div>
          </div>

          <div class="card" style="margin-bottom:12px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <strong>Organization Health</strong>
              <div id="orgHealthScore">â€”</div>
            </div>
          </div>

          <div class="row" style="margin-bottom:12px;">
            <select id="deviceFilter">
              <option value="all">All</option>
              <option value="offline">Offline / Disconnected</option>
              <option value="online">Online</option>
            </select>

            <input id="deviceSearch" placeholder="Search devices..." style="min-width:260px;" />
          </div>

          <div id="deviceLoading" class="muted">Loading devicesâ€¦</div>

          <table id="deviceTable" style="display:none">
            <thead>
              <tr>
                <th onclick="sortDevices('displayName')">Name</th>
                <th onclick="sortDevices('product')">Model</th>
                <th onclick="sortDevices('connectionStatus')">Status</th>
                <th onclick="sortDevices('lastSeen')">Last Seen</th>
                <th onclick="sortDevices('health')">Health</th>
                <th>Location</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody id="deviceRows"></tbody>
          </table>

        </div>
      </section>

      <!-- ANALYTICS TAB -->
      <section id="tab-analytics" class="tabpanel hidden">
        <div class="card">
          <h2>Calling Analytics (7 Day Summary)</h2>
          <div id="analyticsLoading" class="muted">Loading analyticsâ€¦</div>
          <div id="analyticsData"></div>
        </div>
      </section>

      <!-- CDR TAB -->
      <section id="tab-cdr" class="tabpanel hidden">
        <div class="card">
          <h2>Call Detail Records</h2>
          <div id="cdrLoading" class="muted">Loading CDRâ€¦</div>

          <table id="cdrTable" style="display:none">
            <thead>
              <tr>
                <th>Start Time</th>
                <th>Caller</th>
                <th>Callee</th>
                <th>Duration</th>
                <th>Result</th>
              </tr>
            </thead>
            <tbody id="cdrRows"></tbody>
          </table>
        </div>
      </section>

    </div>
  </div>
</div>

<!-- ============================= -->
<!-- DEVICE MODAL (UNCHANGED) -->
<!-- ============================= -->
<div id="deviceModal" style="
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.5);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999;
">
  <div style="
    background:var(--card);
    padding:24px;
    border-radius:14px;
    width:500px;
    max-width:90%;
  ">
    <h3 id="modalTitle"></h3>
    <div id="modalContent" class="muted" style="margin-top:10px;"></div>
    <div style="margin-top:16px; text-align:right;">
      <button onclick="closeDeviceModal()">Close</button>
    </div>
  </div>
</div>
<script>
  const $ = (id) => document.getElementById(id);

  // -----------------------------
  // Theme (default light, persisted)
  // -----------------------------
  function loadTheme() {
    const saved = localStorage.getItem("uiTheme");
    const theme = saved === "dark" ? "dark" : "light";
    document.documentElement.setAttribute("data-theme", theme);
    $("btnTheme").textContent = theme === "dark" ? "Light Mode" : "Dark Mode";
  }

  function toggleTheme() {
    const cur = document.documentElement.getAttribute("data-theme") || "light";
    const next = cur === "dark" ? "light" : "dark";
    localStorage.setItem("uiTheme", next);
    loadTheme();
  }

  $("btnTheme").addEventListener("click", toggleTheme);
  loadTheme();

  // -----------------------------
  // Helpers
  // -----------------------------
  function setError(msg) {
    const box = $("errBox");
    if (!msg) {
      box.style.display = "none";
      box.textContent = "";
      return;
    }
    box.style.display = "block";
    box.textContent = msg;
  }

  async function api(path, opts) {
    const res = await fetch(path, opts);
    const txt = await res.text();
    let data = null;
    try { data = txt ? JSON.parse(txt) : null; } catch { data = { raw: txt }; }
    return { ok: res.ok, status: res.status, data };
  }

 async function loadDevices() {
  $("deviceLoading").style.display = "block";
  $("deviceTable").style.display = "none";

  const orgId = SELECTED_ORG_ID || "";
  const q = orgId ? `?orgId=${encodeURIComponent(orgId)}` : "";
  const r = await api(`/api/devices${q}`);

  if (!r.ok) {
    $("deviceLoading").textContent = "Failed to load devices.";
    return;
  }

  const items = r.data.items || [];

if (!items.length) {
  $("deviceLoading").textContent = "No devices found.";
  $("deviceTable").style.display = "none";   // ðŸ‘ˆ ADD THIS
  DEVICE_CACHE = [];
  return;
}

  $("deviceLoading").style.display = "none";
  $("deviceTable").style.display = "table";

  DEVICE_CACHE = items;
renderDevices(items);

}
function normalizeStatus(status) {
  if (!status) return "offline";

  const s = status.toLowerCase();

  if (s.includes("issue")) return "warning";
  if (s.includes("connected") && !s.includes("disconnected")) return "online";
  return "offline";
}

function renderDevices(devices) {
  const filter = $("deviceFilter").value;
  const search = $("deviceSearch").value.toLowerCase();

  let working = [...devices];

if (DEVICE_SORT_KEY) {
  working.sort((a, b) => {

  let valA;
let valB;

if (DEVICE_SORT_KEY === "health") {
  valA = calculateHealthScore(a);
  valB = calculateHealthScore(b);
} else {
  valA = a[DEVICE_SORT_KEY];
  valB = b[DEVICE_SORT_KEY];
}


    if (DEVICE_SORT_KEY === "lastSeen") {
      valA = valA ? new Date(valA).getTime() : 0;
      valB = valB ? new Date(valB).getTime() : 0;
    } else {
      valA = (valA || "").toString().toLowerCase();
      valB = (valB || "").toString().toLowerCase();
    }

    if (valA < valB) return DEVICE_SORT_ASC ? -1 : 1;
    if (valA > valB) return DEVICE_SORT_ASC ? 1 : -1;
    return 0;
  });
}


const filtered = working.filter(d => {

    const normalized = normalizeStatus(d.connectionStatus);
    const matchesFilter =
      filter === "all" ||
      (filter === "online" && normalized === "online") ||
      (filter === "offline" && normalized !== "online");

    const matchesSearch =
      !search ||
      (d.displayName || "").toLowerCase().includes(search) ||
      (d.product || "").toLowerCase().includes(search);

    return matchesFilter && matchesSearch;
  });

  const offlineCount = devices.filter(d =>
    normalizeStatus(d.connectionStatus) !== "online"
  ).length;

  $("deviceSummary").textContent =
    `${devices.length} devices â€¢ ${offlineCount} offline/disconnected`;
updateOrgHealth(devices);
  
  $("deviceRows").innerHTML = filtered.map(d => {
    const normalized = normalizeStatus(d.connectionStatus);

    const statusClass =
      normalized === "online"
        ? "status-online"
        : normalized === "warning"
        ? "status-warning"
        : "status-offline";

    const statusLabel =
      normalized === "online"
        ? "ONLINE"
        : normalized === "warning"
        ? "ISSUES"
        : "OFFLINE";
    const healthScore = calculateHealthScore(d);

let healthClass =
  healthScore >= 85 ? "health-good" :
  healthScore >= 60 ? "health-mid" :
  "health-bad";


   return `
  <tr>
    <td>
      <span style="cursor:pointer; font-weight:600;"
        onclick="openDeviceModalById('${escapeHtml(d.id || "")}')">
        ${escapeHtml(d.displayName || "â€”")}
      </span>
    </td>
    <td>${escapeHtml(d.product || "â€”")}</td>
    <td>
      <span class="status-badge ${statusClass}">
        ${statusLabel}
      </span>
      ${normalized === "online" ? `
        <div class="muted" style="font-size:11px;">
          Uptime: ${calculateUptime(d.lastSeen, d.connectionStatus)}
        </div>
      ` : ""}
    </td>
    <td>
      ${d.lastSeen ? `
        ${new Date(d.lastSeen).toLocaleString()}
        <div class="muted" style="font-size:11px;">
          ${timeAgo(d.lastSeen)}
        </div>
      ` : "â€”"}
    </td>

    <!-- HEALTH COLUMN -->
    <td>
      <span class="health-pill ${healthClass}">
        ${healthScore}%
      </span>
    </td>

    <td>${normalized === "offline" ? "Power / site outage likely" : "â€”"}</td>
  </tr>
`;
  }).join("");
}

  function openDeviceModalById(id) {
  const device = DEVICE_CACHE.find(d => d.id === id);
  if (!device) return;
  openDeviceModal(device);
}

  function safeOrgLabel(o) {
    const name = o.displayName || o.name || o.orgName || "Unknown";
    const id = o.id || o.orgId || "";
    return `${name}${id ? " â€” " + id.slice(0, 10) + "â€¦" : ""}`;
  }
async function loadAnalytics() {
  $("analyticsLoading").style.display = "block";
  $("analyticsData").innerHTML = "";

  const orgId = SELECTED_ORG_ID || "";
  const r = await api(`/api/analytics?orgId=${encodeURIComponent(orgId)}`);

  if (!r.ok) {
    $("analyticsLoading").textContent = "Failed to load analytics.";
    return;
  }

  $("analyticsLoading").style.display = "none";

  const d = r.data;

  const total = d?.data?.aggregations?.[0]?.metrics?.[0]?.value || 0;

  $("analyticsData").innerHTML = `
    <p><strong>Total Calls (7 days):</strong> ${total}</p>
  `;
}
async function loadCDR() {
  $("cdrLoading").style.display = "block";
  $("cdrTable").style.display = "none";

  const orgId = SELECTED_ORG_ID || "";
  const r = await api(`/api/cdr?orgId=${encodeURIComponent(orgId)}`);

  if (!r.ok) {
    $("cdrLoading").textContent = "Failed to load CDR.";
    return;
  }

  const items = r.data.items || [];

  if (!items.length) {
    $("cdrLoading").textContent = "No CDR records found.";
    return;
  }

  $("cdrLoading").style.display = "none";
  $("cdrTable").style.display = "table";

  $("cdrRows").innerHTML = items.map(c => `
    <tr>
      <td>${new Date(c.startTime).toLocaleString()}</td>
      <td>${escapeHtml(c.localNumber || "â€”")}</td>
      <td>${escapeHtml(c.remoteNumber || "â€”")}</td>
      <td>${fmtInt(c.duration || 0)}s</td>
      <td>${escapeHtml(c.callResult || "â€”")}</td>
    </tr>
  `).join("");
}

  // -----------------------------
  // State
  // -----------------------------
  let ME = null;
  let ORGS = [];
  let SELECTED_ORG_ID = null;
  
// Load guards (prevents repeated API calls)
let ANALYTICS_LOADED = false;
let CDR_LOADED = false;
let DEVICE_CACHE = [];

let DEVICE_SORT_KEY = null;
let DEVICE_SORT_ASC = true;

  let DEVICE_REFRESH_INTERVAL = null;
  let DEVICES_LOADED = false;


  // -----------------------------
  // Load /api/me
  // -----------------------------
async function loadMe() {
  const r = await api("/api/me");
  if (!r.ok) throw new Error("Failed to load /api/me");

  ME = r.data;

if (ME.role !== "admin" && !ME.orgId) {
  window.location.href = "/pin";
  return;
}

  $("whoLine").textContent = `${ME.email} (${ME.role})`;
  $("tenantPill").textContent = `Tenant: ${ME.orgName || "â€”"}`;

  $("orgContext").textContent = ME.orgName
    ? `${ME.orgName} (${ME.resolution} resolution)`
    : "No tenant resolved";

const reportEmail = $("reportEmail");
if (reportEmail) {
  reportEmail.value = ME.email || "";
}
  $("admin-note").style.display = ME.role === "admin" ? "block" : "none";

  return true; // âœ… OK to continue
}

  // -----------------------------
  // Load org list (admin: all, customer: one)
  // Uses your existing /api/org route
  // -----------------------------
  async function loadOrgs() {
    const r = await api("/api/org");
    if (!r.ok) {
      // If tenant not resolved (customer), show helpful message
     if (r.status === 401) {
  setError("Tenant not resolved. Please verify your PIN or contact US Signal.");
$("licenseLoading").textContent = "Tenant not resolved.";
return;

}
 else {
        setError("Failed to load org list.");
      }
      return;
    }

    ORGS = Array.isArray(r.data) ? r.data : [];
    const sel = $("tenantSelect");
    sel.innerHTML = "";

    if (ORGS.length === 0) {
      sel.innerHTML = `<option value="">No organizations available</option>`;
      sel.disabled = true;
      $("btnLoad").disabled = true;
      return;
    }

    // Build options
    for (const o of ORGS) {
      const opt = document.createElement("option");
      opt.value = o.id || o.orgId || "";
      opt.textContent = safeOrgLabel(o);
      sel.appendChild(opt);
    }

    sel.disabled = false;
    $("btnLoad").disabled = false;

    // Choose default
    const defaultOrgId = ME?.orgId || (ORGS[0].id || ORGS[0].orgId);
    if (defaultOrgId) sel.value = defaultOrgId;
    SELECTED_ORG_ID = sel.value;
  }

 $("tenantSelect").addEventListener("change", () => {
  SELECTED_ORG_ID = $("tenantSelect").value;
  setError(null);

  // Reset tab load states for new tenant
  ANALYTICS_LOADED = false;
  CDR_LOADED = false;
  DEVICE_CACHE = [];
  DEVICES_LOADED = false;
});
function initTabs() {
  const tabs = document.querySelectorAll(".tab");

  tabs.forEach(btn => {
    btn.addEventListener("click", async () => {
      tabs.forEach(t => t.classList.remove("active"));
      btn.classList.add("active");

      document
        .querySelectorAll(".tabpanel")
        .forEach(p => p.classList.add("hidden"));

      const target = document.getElementById("tab-" + btn.dataset.tab);
      target.classList.remove("hidden");
if (btn.dataset.tab === "analytics" && !ANALYTICS_LOADED) {
  await loadAnalytics();
  ANALYTICS_LOADED = true;
}

if (btn.dataset.tab === "cdr" && !CDR_LOADED) {
  await loadCDR();
  CDR_LOADED = true;
}

if (btn.dataset.tab === "devices" && !DEVICES_LOADED) {
  await loadDevices();
  DEVICES_LOADED = true;
}

    });
  });
}

  // -----------------------------
  // Load licenses (calls /api/licenses?orgId=...)
  // -----------------------------
  async function loadLicenses() {
    setError(null);
    $("licenseLoading").style.display = "block";
    $("licenseLoading").textContent = "Loading license dataâ€¦";
    $("licenseTable").classList.add("hidden");
    $("licenseRows").innerHTML = "";

    const orgId = SELECTED_ORG_ID || "";
    const q = orgId ? `?orgId=${encodeURIComponent(orgId)}` : "";
    const r = await api(`/api/licenses${q}`);

   if (!r.ok) {
 if (r.status === 401) {
  setError("Tenant not resolved. Please verify your PIN.");
  $("licenseLoading").textContent = "Unauthorized.";
  return;
}

  const msg =
    (r.data && (r.data.message || r.data.error)) ||
    `Failed to load licenses (HTTP ${r.status}).`;
  $("licenseLoading").textContent = msg;
  return;
}


    const items = (r.data && r.data.items) ? r.data.items : [];
const items = Array.isArray(r.data?.items) ? r.data.items : [];

// Always hide loading
$("licenseLoading").style.display = "none";
$("licenseTable").classList.remove("hidden");

// If no items, show empty state row instead of exiting
if (items.length === 0) {
  $("licenseRows").innerHTML = `
    <tr>
      <td colspan="6" class="muted">No license data available for this tenant.</td>
    </tr>
  `;
  renderDeficits([]);
  return;
}

    $("licenseLoading").style.display = "none";
    $("licenseTable").classList.remove("hidden");

    // Expected item shape:
    // { name, consumed, available, status }
  const rows = items.map(l => {
  const name = l.name || l.licenseName || "Unknown";

  const totalRaw = l.total;
  const usedRaw = l.consumed ?? l.assigned ?? 0;

  const total = (totalRaw === null || totalRaw === undefined) ? null : Number(totalRaw);
  const used = Number(usedRaw ?? 0);

  // available: -1 means Unlimited (per your worker)
  const available = (l.available === null || l.available === undefined) ? null : Number(l.available);

  // deficit is already normalized in the worker (0+). If missing, compute safely.
  const deficit = Number.isFinite(Number(l.deficit))
    ? Number(l.deficit)
    : (Number.isFinite(total) && total !== -1 ? Math.max(0, used - total) : 0);

  const status = l.status || "OK";

  const isDeficit = deficit > 0 || status === "DEFICIT";
  const deficitCellClass = isDeficit ? "danger" : "";

  const totalDisplay = (total === -1) ? "Unlimited" : (Number.isFinite(total) ? fmtInt(total) : "â€”");
  const availDisplay = (available === -1) ? "Unlimited" : (Number.isFinite(available) ? fmtInt(available) : "â€”");

  return `
    <tr>
      <td>${escapeHtml(name)}</td>
      <td class="right">${totalDisplay}</td>
      <td class="right">${fmtInt(used)}</td>
      <td class="right">${availDisplay}</td>
      <td class="right ${deficitCellClass}">${fmtInt(deficit)}</td>
      <td>${escapeHtml(String(status))}</td>
    </tr>
  `;
}).join("");


    $("licenseRows").innerHTML = rows;
    renderDeficits(items);
  }
function renderDeficits(items) {
  const tbody = $("deficitRows");
  if (!tbody) return;

  // Only show deficit > 0
  const deficient = (items || []).filter(l => Number(l.deficit || 0) > 0);

  if (!deficient.length) {
    tbody.innerHTML = `<tr><td colspan="5" class="muted">No deficient SKUs ðŸŽ‰</td></tr>`;
    return;
  }

  tbody.innerHTML = deficient.map(l => {
    const name = l.name || l.licenseName || "Unknown";

    const total = (l.total === -1) ? "Unlimited" : (Number.isFinite(Number(l.total)) ? fmtInt(Number(l.total)) : "â€”");
    const used = fmtInt(Number(l.consumed ?? 0));
    const available = (l.available === -1) ? "Unlimited" : (Number.isFinite(Number(l.available)) ? fmtInt(Number(l.available)) : "â€”");
    const needed = fmtInt(Number(l.deficit || 0));

    return `
      <tr>
<td>${escapeHtml(name)}</td>
<td class="right">${available}</td>
<td class="right">${total}</td>
<td class="right">${used}</td>
<td class="right"><strong style="color:var(--bad)">${needed}</strong></td>
      </tr>
    `;
  }).join("");
}

  const btnEmailAlert = $("btnEmailAlert");
if (btnEmailAlert) {
  btnEmailAlert.addEventListener("click", async () => {
    // Sends to the email in the field (defaulted to ME.email)
    await sendReport();
  });
}
$("deviceFilter").addEventListener("change", () => {
  renderDevices(DEVICE_CACHE);
});

$("deviceSearch").addEventListener("input", () => {
  renderDevices(DEVICE_CACHE);
});

  function updateOrgHealth(devices) {
  if (!devices.length) {
    $("orgHealthScore").textContent = "No Data";
    return;
  }

  const avg =
    devices.reduce((sum, d) => sum + calculateHealthScore(d), 0) /
    devices.length;

  const rounded = Math.round(avg);

  let label =
    rounded >= 85 ? "Excellent" :
    rounded >= 70 ? "Good" :
    rounded >= 50 ? "Fair" :
    "Critical";

  $("orgHealthScore").innerHTML = `
    <span class="health-pill ${
      rounded >= 85 ? "health-good" :
      rounded >= 60 ? "health-mid" :
      "health-bad"
    }">
      ${rounded}% â€” ${label}
    </span>
  `;
}

  // -----------------------------
  // Send email (calls /api/licenses/email)
  // -----------------------------
async function sendReport() {
  setError(null);

  const emailStatus = $("emailStatus");
  const emailInput = $("reportEmail");
  const btn = $("btnSendEmail");

  const email = emailInput.value.trim();

  // Reset states
  emailInput.classList.remove("error");
  emailStatus.textContent = "";
  emailStatus.classList.remove("show");

  // Inline validation
  if (!email || !email.includes("@")) {
    emailInput.classList.add("error");
    emailStatus.textContent = "Please enter a valid email address.";
    emailStatus.classList.add("show");
    return;
  }

  const orgId = SELECTED_ORG_ID || null;

  // Disable + spinner
  btn.disabled = true;
  btn.dataset.originalText = btn.innerHTML;
  btn.innerHTML = `<span class="spinner"></span> Sending`;

  try {
    const r = await api("/api/licenses/email", {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify({ email, orgId }),
    });

    if (!r.ok) {
      const msg =
        (r.data && (r.data.message || r.data.error)) ||
        `Email send failed (HTTP ${r.status}).`;

      emailStatus.textContent = "Failed to send report.";
      emailStatus.classList.add("show");
      setError(msg);
      return;
    }

    // Success
    btn.classList.add("success");
    emailStatus.textContent = "âœ… License report sent successfully.";
    emailStatus.classList.add("show");

    // Auto clear after 5s
    setTimeout(() => {
      emailStatus.classList.remove("show");
      emailStatus.textContent = "";
      btn.classList.remove("success");
    }, 5000);

  } catch (err) {
    emailStatus.textContent = "Unexpected error occurred.";
    emailStatus.classList.add("show");
    setError(err.message || "Unexpected error.");
  } finally {
    btn.disabled = false;
    btn.innerHTML = btn.dataset.originalText || "Send Report";
  }
}
  // -----------------------------
  // Utilities
  // -----------------------------
  function openDeviceModal(device) {
  $("modalTitle").textContent = device.displayName || "Device";

  $("modalContent").innerHTML = `
    <strong>Model:</strong> ${escapeHtml(device.product || "â€”")}<br>
    <strong>Status:</strong> ${escapeHtml(device.connectionStatus || "â€”")}<br>
    <strong>Last Seen:</strong> ${
      device.lastSeen
        ? new Date(device.lastSeen).toLocaleString()
        : "â€”"
    }
  `;

  $("deviceModal").style.display = "flex";
}

function closeDeviceModal() {
  $("deviceModal").style.display = "none";
}
  // Close modal when clicking outside inner card
const modalEl = $("deviceModal");
if (modalEl) {
  modalEl.addEventListener("click", (e) => {
    if (e.target.id === "deviceModal") {
      closeDeviceModal();
    }
  });
}

// ESC key support (add ONCE globally)
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") {
    closeDeviceModal();
  }
});


function calculateUptime(lastSeen, status) {
  if (!lastSeen || normalizeStatus(status) !== "online") return "â€”";

  const minutes = Math.floor((Date.now() - new Date(lastSeen)) / 60000);

  if (minutes < 60) return "< 1 hr";
  if (minutes < 1440) return `${Math.floor(minutes / 60)} hrs`;
  return `${Math.floor(minutes / 1440)} days`;
}

  function calculateHealthScore(device) {
  const status = normalizeStatus(device.connectionStatus);

  if (status === "offline") return 20;
  if (status === "warning") return 60;

  if (!device.lastSeen) return 70;

  const minutes = Math.floor((Date.now() - new Date(device.lastSeen)) / 60000);

  if (minutes < 5) return 100;
  if (minutes < 30) return 90;
  if (minutes < 120) return 80;
  if (minutes < 1440) return 70;

  return 50;
}


  function fmtInt(n) {
    if (!Number.isFinite(n)) return "0";
    const sign = n < 0 ? "-" : "";
    const abs = Math.abs(Math.trunc(n));
    return sign + abs.toLocaleString();
  }

  function escapeHtml(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }
  
function timeAgo(dateString) {
  if (!dateString) return "â€”";

  const diffMs = Date.now() - new Date(dateString).getTime();
  const minutes = Math.floor(diffMs / 60000);

  if (minutes < 1) return "just now";
  if (minutes < 60) return `${minutes} min ago`;

  const hours = Math.floor(minutes / 60);
  if (hours < 24) return `${hours} hr ago`;

  const days = Math.floor(hours / 24);
  return `${days} day${days !== 1 ? "s" : ""} ago`;
}
  
function sortDevices(key) {
  if (DEVICE_SORT_KEY === key) {
    DEVICE_SORT_ASC = !DEVICE_SORT_ASC;
  } else {
    DEVICE_SORT_KEY = key;
    DEVICE_SORT_ASC = true;
  }
  renderDevices(DEVICE_CACHE);
}

  // -----------------------------
  // Init
  // -----------------------------
async function init() {
  try {
    setError(null);

    const ok = await loadMe();
    if (!ok) return;

    await loadOrgs();
    SELECTED_ORG_ID = $("tenantSelect").value || SELECTED_ORG_ID;
    initTabs();
    await loadLicenses();

    // ðŸ” Auto refresh devices every 60 seconds
   if (DEVICE_REFRESH_INTERVAL) {
  clearInterval(DEVICE_REFRESH_INTERVAL);
}

DEVICE_REFRESH_INTERVAL = setInterval(() => {

      const active = document.querySelector(".tab.active");
      if (active && active.dataset.tab === "devices") {
        loadDevices();
      }
    }, 60000);

  } catch (e) {
    setError(e?.message || String(e));
  }
}


  init();
</script>


</body>
  
</html>
