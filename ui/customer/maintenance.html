<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8" />
<title>US Signal | Webex Maintenance</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
:root{
  --bg:#f8fafc;
  --card:#ffffff;
  --border:#e2e8f0;
  --text:#0f172a;
  --muted:#64748b;
  --accent:#2563eb;
  --success:#16a34a;
  --warning:#f59e0b;
  --danger:#dc2626;
  --shadow:0 10px 30px rgba(0,0,0,.06);
}

html[data-theme="dark"]{
  --bg:#0b1220;
  --card:#0f172a;
  --border:#1e293b;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --accent:#3b82f6;
  --shadow:0 10px 30px rgba(0,0,0,.35);
}

*{ box-sizing:border-box; font-family:system-ui; }

body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  display:flex;
  height:100vh;
}

/* Sidebar */
.sidebar{
  width:250px;
  background:var(--card);
  border-right:1px solid var(--border);
  padding:20px;
  display:flex;
  flex-direction:column;
}

.nav-link{
  padding:10px 12px;
  border-radius:8px;
  text-decoration:none;
  color:var(--text);
  margin-bottom:6px;
  font-size:14px;
}

.nav-link.active{
  background:rgba(37,99,235,.1);
}

/* Main */
.main{ flex:1; display:flex; flex-direction:column; }

.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:18px 28px;
  background:var(--card);
  border-bottom:1px solid var(--border);
}

.header button{
  padding:8px 10px;
  border-radius:8px;
  border:1px solid var(--border);
  background:var(--card);
  color:var(--text);
  cursor:pointer;
}

.header button:hover{ opacity:.9; }

.content{
  padding:32px;
  overflow:auto;
}

/* KPI */
.kpi-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:20px;
  margin-bottom:30px;
}

.kpi{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  padding:20px;
  box-shadow:var(--shadow);
}

.kpi h3{
  margin:0 0 6px;
  font-size:12px;
  text-transform:uppercase;
  color:var(--muted);
}

.kpi-value{
  font-size:26px;
  font-weight:800;
}

/* Table */
table{
  width:100%;
  border-collapse:collapse;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  overflow:hidden;
  box-shadow:var(--shadow);
}

th, td{
  padding:12px;
  border-bottom:1px solid var(--border);
  text-align:left;
  vertical-align:top;
}

thead th{
  font-size:12px;
  text-transform:uppercase;
  color:var(--muted);
  background:rgba(148,163,184,.08);
}

tbody tr:hover{
  background:rgba(37,99,235,.05);
  cursor:pointer;
}

/* Badges */
.badge{
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:600;
  display:inline-block;
  line-height:1.4;
}

.badge.scheduled{ background:#dbeafe; color:#1d4ed8; }
.badge.inprogress{ background:#fef3c7; color:#b45309; }
.badge.completed{ background:#dcfce7; color:#166534; }

/* Detail */
.detail-row{
  background:rgba(37,99,235,.04);
}

.detail-box{
  padding:18px;
  font-size:14px;
  color:var(--text);
}

.detail-box strong{
  display:inline-block;
  margin-bottom:6px;
}

.detail-box .meta{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin:0 0 14px;
  color:var(--muted);
  font-size:12px;
}

.pill{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  background:rgba(148,163,184,.08);
}

.detail-content{
  padding:14px 16px;
  border:1px solid var(--border);
  background:var(--card);
  border-radius:12px;
  overflow:auto;
}

.detail-content a{
  color:var(--accent);
  text-decoration:none;
}
.detail-content a:hover{ text-decoration:underline; }

/* Buttons */
.btn-email{
  padding:6px 10px;
  border-radius:8px;
  border:none;
  background:var(--accent);
  color:white;
  font-size:12px;
  cursor:pointer;
  white-space:nowrap;
}

.btn-email:hover{ opacity:.88; }

/* Empty */
.empty{
  padding:40px;
  text-align:center;
  color:var(--muted);
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  box-shadow:var(--shadow);
}

.filter-bar{
  margin-bottom:20px;
  display:flex;
  gap:12px;
  align-items:center;
}

select{
  padding:8px 10px;
  border-radius:10px;
  border:1px solid var(--border);
  background:var(--card);
  color:var(--text);
}
</style>
</head>

<body>

<div class="sidebar">
  <h2>Customer Portal</h2>
  <a href="/customer" class="nav-link">Dashboard</a>
  <a href="/customer/maintenance" class="nav-link active">Maintenance</a>
</div>

<div class="main">

  <div class="header">
    <h1 style="margin:0;font-size:18px;">Webex Platform Maintenance</h1>
    <div style="display:flex;gap:10px;">
      <button id="btnTheme" type="button">Toggle Theme</button>
      <button type="button" onclick="loadMaintenance(true)">Refresh</button>
    </div>
  </div>

  <div class="content">

    <div class="kpi-grid">
      <div class="kpi">
        <h3>Upcoming</h3>
        <div class="kpi-value" id="kUpcoming">—</div>
      </div>
      <div class="kpi">
        <h3>Active</h3>
        <div class="kpi-value" id="kActive">—</div>
      </div>
      <div class="kpi">
        <h3>Completed</h3>
        <div class="kpi-value" id="kCompleted">—</div>
      </div>
    </div>

    <div class="filter-bar">
      <select id="productFilter">
        <option value="">All Products</option>
      </select>
    </div>

    <div id="maintenanceContainer"></div>

  </div>
</div>

<script>
const CACHE_KEY = "maintenanceCacheV3";
const CACHE_TTL = 5 * 60 * 1000;

/* =========================
   THEME
========================= */
function loadTheme(){
  const saved = localStorage.getItem("uiTheme") || "light";
  document.documentElement.setAttribute("data-theme", saved);
}

document.getElementById("btnTheme").onclick = function(){
  const cur = document.documentElement.getAttribute("data-theme");
  const next = cur === "dark" ? "light" : "dark";
  localStorage.setItem("uiTheme", next);
  loadTheme();
};

loadTheme();

/* =========================
   HELPERS
========================= */
function escapeHtml(s){
  return String(s ?? "")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#39;");
}

/**
 * Webex "updates.body" often includes HTML such as <strong> and <a>.
 * We allow a small safe subset:
 * - <strong>, <b>, <em>, <i>, <br>, <p>, <ul>, <ol>, <li>, <a href=...>
 * Everything else is stripped.
 */
function sanitizeLimitedHtml(html){
  const raw = String(html || "").trim();
  if(!raw) return "";

  const tpl = document.createElement("template");
  tpl.innerHTML = raw;

  const allowedTags = new Set(["STRONG","B","EM","I","BR","P","UL","OL","LI","A","DIV","SPAN"]);
  const allowedAttrs = {
    "A": new Set(["href","target","rel"])
  };

  function cleanNode(node){
    const children = Array.from(node.childNodes);
    for(const child of children){
      if(child.nodeType === Node.ELEMENT_NODE){
        const tag = child.tagName;

        if(!allowedTags.has(tag)){
          // unwrap the element but keep its children text
          const frag = document.createDocumentFragment();
          while(child.firstChild) frag.appendChild(child.firstChild);
          child.replaceWith(frag);
          continue;
        }

        // strip attributes not allowed
        const attrs = Array.from(child.attributes || []);
        for(const a of attrs){
          const name = a.name.toLowerCase();
          const ok = (allowedAttrs[tag] && allowedAttrs[tag].has(name)) || false;
          if(!ok) child.removeAttribute(a.name);
        }

        // harden links
        if(tag === "A"){
          const href = child.getAttribute("href") || "";
          const safeHref = href.startsWith("http://") || href.startsWith("https://");
          if(!safeHref){
            child.removeAttribute("href");
          } else {
            child.setAttribute("target","_blank");
            child.setAttribute("rel","noopener noreferrer");
          }
        }

        cleanNode(child);
      }
      else if(child.nodeType === Node.COMMENT_NODE){
        child.remove();
      }
      else{
        // text nodes are fine
      }
    }
  }

  cleanNode(tpl.content);

  // Convert bare newlines to <br> if there's no block structure
  let out = tpl.innerHTML;
  if(!/<(p|ul|ol|li|br|div|span|strong|b|em|i|a)\b/i.test(out)){
    out = escapeHtml(raw).replace(/\n/g,"<br>");
  }

  return out;
}

function fmtDate(iso){
  if(!iso) return "—";
  try { return new Date(iso).toLocaleString(); }
  catch { return "—"; }
}

function badgeClass(status){
  const s=(status||"").toLowerCase();
  if(s.includes("progress")) return "inprogress";
  if(s==="completed") return "completed";
  return "scheduled";
}

/* =========================
   FETCH
========================= */
async function fetchMaintenance(){
  try{
    const res = await fetch("/api/maintenance", { cache:"no-store" });
    if(!res.ok) return null;
    return await res.json();
  }catch(e){
    console.error("Maintenance fetch failed", e);
    return null;
  }
}

async function loadProductFilter(){
  try{
    const res = await fetch("/api/components", { cache:"no-store" });
    if(!res.ok) return;

    const data = await res.json();
    const select = document.getElementById("productFilter");

    const groups = Object.keys(data.grouped || {});
    groups.sort((a,b)=>a.localeCompare(b));

    for(const group of groups){
      const opt = document.createElement("option");
      opt.value = group;
      opt.textContent = group;
      select.appendChild(opt);
    }
  }catch(e){
    console.error("Component load failed", e);
  }
}

/* =========================
   LOAD
========================= */
async function loadMaintenance(force){

  if(!force){
    const cached = JSON.parse(localStorage.getItem(CACHE_KEY) || "null");
    if(cached && (Date.now() - cached.timestamp) < CACHE_TTL){
      render(cached.data);
      return;
    }
  }

  const data = await fetchMaintenance();
  if(!data) return;

  localStorage.setItem(CACHE_KEY, JSON.stringify({
    timestamp: Date.now(),
    data
  }));

  render(data);
}

/* =========================
   RENDER
========================= */
function render(data){

  const container = document.getElementById("maintenanceContainer");
  container.innerHTML = "";

  const items = data.maintenance || [];

  const upcoming = items.filter(m => (m.status||"").toLowerCase()==="scheduled");
  const active = items.filter(m => (m.status||"").toLowerCase().includes("progress"));
  const completed = items.filter(m => (m.status||"").toLowerCase()==="completed");

  document.getElementById("kUpcoming").textContent = upcoming.length;
  document.getElementById("kActive").textContent = active.length;
  document.getElementById("kCompleted").textContent = completed.length;

  const filterValue = document.getElementById("productFilter").value;

  let filtered = items;

  if(filterValue){
    filtered = items.filter(m =>
      (m.components || []).some(c => (c.group || c.product_group) === filterValue)
    );
  }

  if(filtered.length === 0){
    container.innerHTML = `<div class="empty">No maintenance events found.</div>`;
    return;
  }

  // sort newest first by created_at
  filtered.sort((a,b)=>{
    const ta = a.created_at ? new Date(a.created_at).getTime() : 0;
    const tb = b.created_at ? new Date(b.created_at).getTime() : 0;
    return tb - ta;
  });

  const table = document.createElement("table");
  let rows = "";

  filtered.forEach((m,index)=>{

    const id = `detail-${index}`;
    const dateStr = fmtDate(m.created_at);

    const compNames = (m.components || []).map(c => c.name).filter(Boolean);
    const productsAffected = compNames.length ? compNames.join(", ") : "—";

    // ✅ This is the key: Worker provides detailsHtml (full body)
    const detailsHtml = sanitizeLimitedHtml(m.detailsHtml || m.body || m.description || "");

    rows += `
      <tr onclick="toggleDetail('${id}')">
        <td>${escapeHtml(dateStr)}</td>
        <td><span class="badge ${badgeClass(m.status)}">${escapeHtml(m.status||"—")}</span></td>
        <td>${escapeHtml(m.impact||"—")}</td>
        <td>${escapeHtml(m.name||"—")}</td>
        <td style="text-align:right;">
          <button class="btn-email"
            type="button"
            onclick="event.stopPropagation(); notify('${escapeHtml(m.id)}')">
            Email
          </button>
        </td>
      </tr>

      <tr id="${id}" class="detail-row" style="display:none;">
        <td colspan="5">
          <div class="detail-box">
            <div class="meta">
              <span class="pill">Created: ${escapeHtml(fmtDate(m.created_at))}</span>
              <span class="pill">Updated: ${escapeHtml(fmtDate(m.updated_at))}</span>
              <span class="pill">ID: ${escapeHtml(m.id || "—")}</span>
            </div>

            <strong>Maintenance details:</strong>
            <div class="detail-content">
              ${detailsHtml || "No details available."}
            </div>

            <div style="height:12px;"></div>

            <strong>Products Affected:</strong><br/>
            ${escapeHtml(productsAffected)}
          </div>
        </td>
      </tr>
    `;
  });

  table.innerHTML = `
    <thead>
      <tr>
        <th style="width:210px;">Date</th>
        <th style="width:120px;">Status</th>
        <th style="width:140px;">Impact</th>
        <th>Name</th>
        <th style="width:90px;"></th>
      </tr>
    </thead>
    <tbody>${rows}</tbody>
  `;

  container.appendChild(table);
}

function toggleDetail(id){
  const row = document.getElementById(id);
  if(!row) return;
  row.style.display = row.style.display==="none" ? "table-row" : "none";
}

/* =========================
   EMAIL NOTIFY
========================= */
async function notify(maintenanceId){

  const email = prompt("Enter email address to notify:");
  if(!email) return;

  try{
    const res = await fetch("/api/maintenance/notify",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        maintenanceId,
        email
      })
    });

    const text = await res.text();
    let payload = null;
    try{ payload = JSON.parse(text); }catch{}

    if(!res.ok){
      console.error("Notify failed", res.status, text);
      alert(payload?.error ? `Failed: ${payload.error}` : "Failed to send notification.");
      return;
    }

    alert("Notification sent successfully.");
  }
  catch(e){
    console.error("Notification error", e);
    alert("Notification error.");
  }
}

/* =========================
   INIT
========================= */
document.getElementById("productFilter")
  .addEventListener("change",()=>loadMaintenance(true));

loadProductFilter();
loadMaintenance(false);
</script>

</body>
</html>
