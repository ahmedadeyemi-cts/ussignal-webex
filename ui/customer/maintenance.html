<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8" />
<title>US Signal | Webex Maintenance</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
:root{
  --bg:#f8fafc;
  --card:#ffffff;
  --border:#e2e8f0;
  --text:#0f172a;
  --muted:#64748b;
  --accent:#2563eb;
  --success:#16a34a;
  --warning:#f59e0b;
  --danger:#dc2626;
  --shadow:0 10px 30px rgba(0,0,0,.06);
}

html[data-theme="dark"]{
  --bg:#0b1220;
  --card:#0f172a;
  --border:#1e293b;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --accent:#3b82f6;
  --shadow:0 10px 30px rgba(0,0,0,.35);
}

*{ box-sizing:border-box; font-family:system-ui; }

body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  display:flex;
  height:100vh;
}

/* Sidebar */
.sidebar{
  width:250px;
  background:var(--card);
  border-right:1px solid var(--border);
  padding:20px;
  display:flex;
  flex-direction:column;
}

.nav-link{
  padding:10px 12px;
  border-radius:8px;
  text-decoration:none;
  color:var(--text);
  margin-bottom:6px;
  font-size:14px;
}

.nav-link.active{
  background:rgba(37,99,235,.1);
}

/* Main */
.main{ flex:1; display:flex; flex-direction:column; }

.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:18px 28px;
  background:var(--card);
  border-bottom:1px solid var(--border);
}

.content{
  padding:32px;
  overflow:auto;
}

/* KPI */
.kpi-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:20px;
  margin-bottom:30px;
}

.kpi{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  padding:20px;
  box-shadow:var(--shadow);
}

.kpi h3{
  margin:0 0 6px;
  font-size:12px;
  text-transform:uppercase;
  color:var(--muted);
}

.kpi-value{
  font-size:26px;
  font-weight:800;
}

/* Section */
.section{
  margin-bottom:40px;
}

/* Table */
table{
  width:100%;
  border-collapse:collapse;
}

th, td{
  padding:12px;
  border-bottom:1px solid var(--border);
  text-align:left;
}

tr:hover{
  background:rgba(37,99,235,.05);
  cursor:pointer;
}

/* Badges */
.badge{
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:600;
}

.badge.scheduled{ background:#dbeafe; color:#1d4ed8; }
.badge.inprogress{ background:#fef3c7; color:#b45309; }
.badge.completed{ background:#dcfce7; color:#166534; }

/* Detail */
.detail-row{
  background:rgba(37,99,235,.04);
}

.detail-box{
  padding:18px;
  font-size:14px;
}

/* Buttons */
.btn-email{
  padding:6px 10px;
  border-radius:6px;
  border:none;
  background:var(--accent);
  color:white;
  font-size:12px;
  cursor:pointer;
}

.btn-email:hover{
  opacity:.85;
}

/* Empty */
.empty{
  padding:40px;
  text-align:center;
  color:var(--muted);
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
}

.filter-bar{
  margin-bottom:20px;
  display:flex;
  gap:12px;
}

select{
  padding:8px;
  border-radius:6px;
  border:1px solid var(--border);
}
</style>
</head>

<body>

<div class="sidebar">
  <h2>Customer Portal</h2>
  <a href="/customer" class="nav-link">Dashboard</a>
  <a href="/customer/maintenance" class="nav-link active">Maintenance</a>
</div>

<div class="main">

<div class="header">
  <h1>Webex Platform Maintenance</h1>
  <div>
    <button id="btnTheme">Toggle Theme</button>
    <button onclick="loadMaintenance(true)">Refresh</button>
  </div>
</div>

<div class="content">

  <div class="kpi-grid">
    <div class="kpi">
      <h3>Upcoming</h3>
      <div class="kpi-value" id="kUpcoming">—</div>
    </div>
    <div class="kpi">
      <h3>Active</h3>
      <div class="kpi-value" id="kActive">—</div>
    </div>
    <div class="kpi">
      <h3>Completed</h3>
      <div class="kpi-value" id="kCompleted">—</div>
    </div>
  </div>

  <div class="filter-bar">
    <select id="productFilter">
      <option value="">All Products</option>
    </select>
  </div>

  <div id="maintenanceContainer"></div>

</div>
</div>

<script>
const CACHE_KEY = "maintenanceCacheV2";
const CACHE_TTL = 5 * 60 * 1000;

/* =========================
   THEME
========================= */
function loadTheme(){
  const saved = localStorage.getItem("uiTheme") || "light";
  document.documentElement.setAttribute("data-theme", saved);
}

document.getElementById("btnTheme").onclick = function(){
  const cur = document.documentElement.getAttribute("data-theme");
  const next = cur === "dark" ? "light" : "dark";
  localStorage.setItem("uiTheme", next);
  loadTheme();
};

loadTheme();

/* =========================
   FETCH
========================= */
async function fetchMaintenance(){
  const res = await fetch("/api/maintenance", { cache:"no-store" });
  if(!res.ok) return null;
  return await res.json();
}

async function loadProductFilter(){
  try{
    const res = await fetch("/api/components");
    if(!res.ok) return;

    const data = await res.json();
    const select = document.getElementById("productFilter");

    Object.keys(data.grouped || {}).forEach(group=>{
      const opt = document.createElement("option");
      opt.value = group;
      opt.textContent = group;
      select.appendChild(opt);
    });
  }catch(e){
    console.error("Component load failed");
  }
}

/* =========================
   LOAD
========================= */
async function loadMaintenance(force){

  if(!force){
    const cached = JSON.parse(localStorage.getItem(CACHE_KEY) || "null");
    if(cached && (Date.now() - cached.timestamp) < CACHE_TTL){
      render(cached.data);
      return;
    }
  }

  const data = await fetchMaintenance();
  if(!data) return;

  localStorage.setItem(CACHE_KEY, JSON.stringify({
    timestamp: Date.now(),
    data
  }));

  render(data);
}

/* =========================
   RENDER
========================= */
function render(data){

  const container = document.getElementById("maintenanceContainer");
  container.innerHTML = "";

  const items = data.maintenance || [];

  const upcoming = items.filter(m => (m.status||"").toLowerCase()==="scheduled");
  const active = items.filter(m => (m.status||"").toLowerCase().includes("progress"));
  const completed = items.filter(m => (m.status||"").toLowerCase()==="completed");

  document.getElementById("kUpcoming").textContent = upcoming.length;
  document.getElementById("kActive").textContent = active.length;
  document.getElementById("kCompleted").textContent = completed.length;

  const filterValue = document.getElementById("productFilter").value;

  let filtered = items;

  if(filterValue){
    filtered = items.filter(m =>
      (m.components || []).some(c => c.group === filterValue)
    );
  }

  if(filtered.length === 0){
    container.innerHTML = `<div class="empty">No maintenance events found.</div>`;
    return;
  }

  const table = document.createElement("table");
  let rows = "";

  filtered.forEach((m,index)=>{

    const id = `detail-${index}`;
    const dateStr = m.created_at
      ? new Date(m.created_at).toLocaleString()
      : "—";

    rows += `
      <tr onclick="toggleDetail('${id}')">
        <td>${dateStr}</td>
        <td><span class="badge ${badgeClass(m.status)}">${m.status||"—"}</span></td>
        <td>${m.impact||"—"}</td>
        <td>${m.name||"—"}</td>
        <td>
          <button class="btn-email"
            onclick="event.stopPropagation(); notify('${m.id}')">
            Email
          </button>
        </td>
      </tr>

      <tr id="${id}" class="detail-row" style="display:none;">
        <td colspan="5">
          <div class="detail-box">
            <strong>Description:</strong><br/>
            ${(m.body || m.description || "No details available.")}
            <br/><br/>
            <strong>Products Affected:</strong><br/>
            ${(m.components||[]).map(c=>c.name).join(", ") || "—"}
          </div>
        </td>
      </tr>
    `;
  });

  table.innerHTML = `
    <thead>
      <tr>
        <th>Date</th>
        <th>Status</th>
        <th>Impact</th>
        <th>Name</th>
        <th></th>
      </tr>
    </thead>
    <tbody>${rows}</tbody>
  `;

  container.appendChild(table);
}

function toggleDetail(id){
  const row = document.getElementById(id);
  if(!row) return;
  row.style.display = row.style.display==="none" ? "table-row" : "none";
}

function badgeClass(status){
  const s=(status||"").toLowerCase();
  if(s.includes("progress")) return "inprogress";
  if(s==="completed") return "completed";
  return "scheduled";
}

/* =========================
   EMAIL NOTIFY
========================= */
async function notify(maintenanceId){

  const email = prompt("Enter email address to notify:");
  if(!email) return;

  try{
    const res = await fetch("/api/maintenance/notify",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        maintenanceId,
        email
      })
    });

    if(!res.ok){
      alert("Failed to send notification.");
      return;
    }

    alert("Notification sent successfully.");
  }
  catch(e){
    alert("Notification error.");
  }
}

/* =========================
   INIT
========================= */
document.getElementById("productFilter")
  .addEventListener("change",()=>loadMaintenance(true));

loadProductFilter();
loadMaintenance(false);

</script>

</body>
</html>
