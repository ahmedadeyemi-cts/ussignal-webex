<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8" />
<title>US Signal | Webex Calling PSTN Command Center</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root{
 --bg:#f6f8fb;
 --card:#ffffff;
 --text:#0f172a;
 --muted:#64748b;
 --line:rgba(15,23,42,.10);
 --shadow:0 8px 24px rgba(15,23,42,.08);
 --accent:#0f62fe;
 --good:#16a34a;
 --warn:#f59e0b;
 --bad:#dc2626;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text);display:flex;min-height:100vh}
.sidebar{width:260px;background:var(--card);border-right:1px solid var(--line);padding:18px;display:flex;flex-direction:column;gap:14px}
.sidebar a{padding:10px;border-radius:12px;font-weight:800;font-size:13px;text-decoration:none;color:var(--text)}
.sidebar a.active{background:rgba(15,98,254,.12);border:1px solid rgba(15,98,254,.2)}
.sidebarBottom{margin-top:auto;display:flex;flex-direction:column;gap:10px}
.summary-pill{padding:12px;border-radius:12px;font-weight:900;text-align:center}
.summary-green{background:rgba(22,163,74,.15);color:var(--good)}
.summary-amber{background:rgba(245,158,11,.15);color:var(--warn)}
.summary-red{background:rgba(220,38,38,.15);color:var(--bad)}
.main{flex:1;padding:22px;display:flex;flex-direction:column;gap:18px}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:16px}
h2{margin:0 0 10px 0;font-size:14px;font-weight:1000}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.kpi{padding:12px;border-radius:14px;border:1px solid rgba(15,23,42,.08)}
.kpi .value{font-size:22px;font-weight:1100}
.table-wrap{border:1px solid var(--line);border-radius:16px;overflow:auto}
table{width:100%;border-collapse:collapse}
thead th{padding:10px;font-size:12px;color:var(--muted);text-transform:uppercase}
tbody td{padding:10px;border-top:1px solid rgba(15,23,42,.06);font-size:13px}
.badge{padding:4px 10px;border-radius:999px;font-size:11px;font-weight:900}
.badge.good{background:rgba(22,163,74,.15);color:var(--good)}
.badge.warn{background:rgba(245,158,11,.15);color:var(--warn)}
.badge.bad{background:rgba(220,38,38,.15);color:var(--bad)}
canvas{width:100%;height:160px}
</style>
</head>
<body>

<div class="sidebar">
 <a href="/customer">Dashboard</a>
 <a href="/customer/licenses">Licenses</a>
 <a href="/customer/devices">Devices</a>
 <a href="/customer/analytics">Analytics</a>
 <a href="/customer/cdr">CDR</a>
 <a href="/customer/pstn" class="active">PSTN</a>
 <div class="sidebarBottom">
   <div id="rag" class="summary-pill summary-green">GREEN</div>
   <button onclick="logout()">Logout</button>
 </div>
</div>

<div class="main">

<div class="card">
<h2>PSTN Global Health</h2>
<div class="grid">
 <div class="kpi"><div>Trunks</div><div id="kTrunks" class="value">—</div></div>
 <div class="kpi"><div>DIDs</div><div id="kDids" class="value">—</div></div>
 <div class="kpi"><div>Gateways</div><div id="kGateways" class="value">—</div></div>
 <div class="kpi"><div>Capacity Risk</div><div id="kRisk" class="value">—</div></div>
</div>
</div>

<div class="card">
<h2>Call Routing Simulation</h2>
<input id="simNumber" placeholder="Enter E.164 number">
<button onclick="simulate()">Simulate</button>
<div id="simResult"></div>
</div>

<div class="card">
<h2>Failover Path Validation</h2>
<div id="failover"></div>
</div>

<div class="card">
<h2>DID Inventory Reconciliation</h2>
<div id="didAudit"></div>
</div>

<div class="card">
<h2>SBC / Local Gateway Monitoring</h2>
<div id="gatewayStatus"></div>
</div>

<div class="card">
<h2>E911 Compliance Audit</h2>
<div id="e911Audit"></div>
</div>

<div class="card">
<h2>Fraud Pattern Detection</h2>
<div id="fraud"></div>
</div>

<div class="card">
<h2>Historical Trunk Utilization</h2>
<canvas id="trend"></canvas>
</div>

</div>

<script>
const $=id=>document.getElementById(id)

async function api(p){
  const r=await fetch(p)
  return r.json()
}

async function init(){

  const me=await api("/api/me")
  if(!me.orgId){
    location="/pin"
    return
  }

  const key=me.orgId

  // Try snapshot first (fast)
  let data = await api(`/api/customer/${key}/pstn`)

  if(!data.ok){
    // fallback to live deep
    data = await api(`/api/customer/${key}/pstn-deep`)
  }

  if(!data.ok){
    alert("PSTN data unavailable")
    return
  }

  const pstn = data.pstn

  // KPIs
  $("kTrunks").textContent = pstn.totals.trunks
  $("kDids").textContent = pstn.totals.didsTotal
  $("kGateways").textContent = pstn.totals.premisePstnConnections
  $("kRisk").textContent = pstn.scores.pstnReliabilityScore

  updateRAGFromScore(pstn.scores.pstnReliabilityScore)

  validateFailover(pstn.locations)
  auditDids(pstn.locations)
  monitorGateways(pstn.locations)
  auditE911(pstn.locations)

  renderTrendPlaceholder()
}

function updateRAGFromScore(score){
  let state="GREEN"
  if(score < 70) state="RED"
  else if(score < 85) state="AMBER"

  const el=$("rag")
  el.className="summary-pill"
  if(state==="RED") el.classList.add("summary-red")
  else if(state==="AMBER") el.classList.add("summary-amber")
  else el.classList.add("summary-green")
  el.textContent=state
}

function validateFailover(locations){
  $("failover").innerHTML =
    locations.map(l=>
      `<div><b>${l.name}</b> → ${
        l.riskFlags.singleTrunkRisk ? "Single Trunk Risk" : "Redundant"
      }</div>`
    ).join("")
}

function auditDids(locations){
  const orphan = locations.reduce((a,l)=>a+(l.dids.unassigned||0),0)
  $("didAudit").textContent = "Unassigned DIDs: "+orphan
}

function monitorGateways(locations){
  const list=[]
  locations.forEach(l=>{
    l.premisePstnConnections.forEach(g=>{
      list.push(`<div>${l.name} → ${g.name} (${g.status||"unknown"})</div>`)
    })
  })
  $("gatewayStatus").innerHTML = list.join("") || "No Local Gateways"
}

function auditE911(locations){
  const nonCompliant = locations.filter(l=>l.riskFlags.e911Missing)
  $("e911Audit").textContent =
    nonCompliant.length===0
      ? "Compliant"
      : nonCompliant.length+" Locations Missing E911"
}

function renderTrendPlaceholder(){
  const c=$("trend")
  const ctx=c.getContext("2d")
  ctx.clearRect(0,0,c.width,c.height)
  ctx.font="14px system-ui"
  ctx.fillText("Historical utilization coming next phase",20,80)
}

function logout(){
  fetch("/api/pin/logout",{method:"POST"}).finally(()=>location="/")
}

init()
</script>
</body>
</html>
