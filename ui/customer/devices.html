<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Devices</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 30px;
      color: #1f2937;
    }

    h1 {
      margin-bottom: 20px;
    }

    .nav {
      margin-bottom: 25px;
    }

    .nav a {
      text-decoration: none;
      margin-right: 20px;
      color: #2563eb;
      font-weight: 600;
    }

    .summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .card h3 {
      margin: 0;
      font-size: 14px;
      color: #6b7280;
    }

    .card .value {
      font-size: 28px;
      font-weight: bold;
      margin-top: 8px;
    }

    .healthy { color: #059669; }
    .warning { color: #d97706; }
    .critical { color: #dc2626; }

    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 600;
    }

    .alert-warning {
      background: #fef3c7;
      color: #92400e;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    th, td {
      padding: 14px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }

    th {
      background: #f9fafb;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: .05em;
      color: #6b7280;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .status-ok {
      color: #059669;
      font-weight: 600;
    }

    .status-offline {
      color: #dc2626;
      font-weight: 600;
    }

    .loading {
      font-size: 14px;
      color: #6b7280;
    }
  </style>
</head>

<body>

  <div class="nav">
    <a href="/customer">Dashboard</a>
    <a href="/customer/licenses">Licenses</a>
    <a href="/customer/devices">Devices</a>
    <a href="/customer/analytics">Analytics</a>
    <a href="/customer/cdr">CDR</a>
  </div>

  <h1>Device Overview</h1>

  <div id="alertContainer"></div>

  <div class="summary">
    <div class="card">
      <h3>Total Endpoints</h3>
      <div id="totalDevices" class="value">-</div>
    </div>

    <div class="card">
      <h3>Connected</h3>
      <div id="connectedDevices" class="value healthy">-</div>
    </div>

    <div class="card">
      <h3>Offline</h3>
      <div id="offlineDevices" class="value critical">-</div>
    </div>
  </div>

  <div class="card">
    <h3>All Devices</h3>
    <div id="loading" class="loading">Loading devicesâ€¦</div>
    <table id="deviceTable" style="display:none;">
      <thead>
        <tr>
          <th>Name</th>
          <th>Model</th>
          <th>Connection Status</th>
        </tr>
      </thead>
      <tbody id="deviceBody"></tbody>
    </table>
  </div>

<script>
async function loadDevices() {
  try {
    const res = await fetch("/api/devices");
    const data = await res.json();

    if (!data || !data.items) {
      document.getElementById("loading").innerText = "Failed to load devices.";
      return;
    }

    const summary = data.summary || {};
    const devices = data.items || [];

    document.getElementById("totalDevices").innerText = summary.totalDevices ?? devices.length;
    document.getElementById("connectedDevices").innerText = summary.connected ?? 0;
    document.getElementById("offlineDevices").innerText = summary.offline ?? 0;

    if (summary.hasOffline) {
      const alert = document.createElement("div");
      alert.className = "alert alert-warning";
      alert.innerText = "Warning: One or more devices are offline.";
      document.getElementById("alertContainer").appendChild(alert);
    }

    const tbody = document.getElementById("deviceBody");

    devices.sort((a, b) => {
      if (a.status === "OFFLINE" && b.status !== "OFFLINE") return -1;
      if (a.status !== "OFFLINE" && b.status === "OFFLINE") return 1;
      return (a.displayName || "").localeCompare(b.displayName || "");
    });

    for (const d of devices) {
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${d.displayName || "-"}</td>
        <td>${d.model || "-"}</td>
        <td class="${d.status === 'OFFLINE' ? 'status-offline' : 'status-ok'}">
          ${d.connectionStatus || d.status}
        </td>
      `;

      tbody.appendChild(tr);
    }

    document.getElementById("loading").style.display = "none";
    document.getElementById("deviceTable").style.display = "table";

  } catch (e) {
    document.getElementById("loading").innerText = "Error loading devices.";
  }
}

loadDevices();
</script>

</body>
</html>
